---
title: "WIP: New function `propop::propop_tables()`"
subtitle: "Run projections with `tibbles`, `purrr` and `dplyr`"
author: "Statistik Aargau (2025), Norah Efosa"
date: April 2025
format:
  html:
    embed-resources: true
    link-external-icon: true
    theme: lumen 
    link-external-newwindow: true
    toc: true
    toc-location: left
    toc-title: "Interactive toc"
    toc-depth: 5
editor_options: 
  chunk_output_type: console
cache: false
---

# Introduction

`propop::propop_tables()` is a `dplyr`-version of `propop::propop()` (matrices).

✅modular structure

✅mainly dplyr-coded

✅more flexibility for adding/removing columns

✅for now, both functions will be kept and maintained

```{r packages, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
# Install propop from the development branch
# devtools::install_github("statistik-aargau/propop", ref = "f-proj-tables2025-2055")

# Load packages
library(propop)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggtext)

add_percent <- function(x) {
  paste0(x, "%")
}
options(scipen = 999)
```

## Overview: `propop_tables()`

### Function arguments

The new function's arguments are identical to `propop::propop()`:

(only the first four arguments in blue are mandatory)

```{r, echo = TRUE, eval = FALSE}
propop::propop_tables(
  parameters,
  population,
  year_first,
  year_last,
  age_groups = 101,
  fert_first = 16,
  fert_last = 50,
  share_born_female = 100 / 205,
  subregional = FALSE,
  binational = TRUE,
  spatial_unit = "spatial_unit"
)
```

### Structure

![](overview_propop_tables.png)

### Performance for one region (Canton of Aargau)

We use STAT-TAB data as described in the [vignette for projecting a single region](vignettes/project_single_region.Rmd):

```{r message = FALSE, warning = FALSE, result = FALSE}
# Run propop with tables (new feature)
system.time({
  result_tables <- propop::propop_tables(
    parameters = fso_parameters,
    year_first = 2019,
    year_last = 2030,
    population = fso_population,
    subregional = FALSE,
    binational = TRUE
  )
})

# Run propop with matrices (original)
system.time({
  result_matrices <- propop::propop(
    parameters = fso_parameters,
    year_first = 2019,
    year_last = 2030,
    population = fso_population,
    subregional = FALSE,
    binational = TRUE
  )
})
```

### Comparison between `propop::tables()` and `propop::propop()` 

```{r comparison-propop, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, result = FALSE}
# Compare results
compare_models <- result_matrices |>
  arrange(year, nat, sex, age) |>
  select(year:nat, births:n_dec) |>
  mutate(acq = case_when(nat == "int" ~ NA, .default = acq)) |>
  tidyr::pivot_longer(
    cols = -c(year:nat),
    names_to = "variable",
    values_to = "n_matrix"
  ) |>
  # join results
  left_join(
    result_tables |>
      mutate(acq_n = case_when(nat == "int" ~ NA, .default = acq_n)) |>
      select(
        year:births,
        mor = mor_n, emi_int = emi_int_n, emi_nat = emi_nat_n,
        imm_int = imm_int_n, imm_nat = imm_nat_n, acq = acq_n, n_dec
      ) |>
      pivot_longer(
        cols = -c(year:age),
        names_to = "variable",
        values_to = "n_tables"
      ),
    by = join_by(year, spatial_unit, age, sex, nat, variable)
  ) |>
  # create age groups
  mutate(
    age_groups = case_when(
      age < 20 ~ "age_00_19",
      age >= 20 & age < 40 ~ "age_20_39",
      age >= 40 & age < 60 ~ "age_40_59",
      age >= 60 & age < 80 ~ "age_60_79",
      age >= 80 ~ "age_80_plus"
    )
  ) |>
  summarize(
    n_matrix = sum(n_matrix, na.rm = TRUE),
    n_tables = sum(n_tables, na.rm = TRUE),
    .by = c(year, spatial_unit, variable, age_groups)
  ) |>
  # compute evaluation
  mutate(
    error = n_matrix - n_tables,
    pe = (error / n_matrix) * 100,
    ape = (abs(error) / n_matrix) * 100
  )
```

```{r plot, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE}
# Plot each projection component
compare_models |>
  mutate(
    pe = case_when((variable == "births" & error == 0) ~ 0, .default = pe),
    variable = factor(
      variable,
      levels = c(
        "n_dec", "births", "imm_int", "imm_nat", "emi_int", "emi_nat",
        "acq", "mor"
      ),
      labels = c(
        "total n", "births", "international immigration",
        "intercantonal immigration", "international emigration",
        "intercantonal emigration", "acquisition of CH citizenship",
        "deaths"
      )
    ),
  ) |>
  ggplot2::ggplot(
    ggplot2::aes(x = as.numeric(year), y = pe, color = age_groups)
  ) +
  geom_hline(yintercept = 0, linewidth = 0.3) +
  geom_point() +
  scale_y_continuous(
    labels = add_percent,
    limits = c(-1, 5),
    breaks = c(-1, 0, 1, 3, 5)
  ) +
  labs(
    title = "Differences between propop_tables() and propop() (benchmark)",
    subtitle = "by projected year and age group across the Canton of Aargau (2019-2030)",
    x = "Year",
    y = "Mean difference in percent"
  ) +
  scale_color_manual(values = rev(c("#007AB8", "#ffa81f", "#A05388", "#ffe562", "#96D4FF"))) +
  scale_shape_manual(values = c(1, 4, 6)) +
  scale_x_continuous(breaks = c(2020, 2025, 2030)) +
  theme_bw() +
  theme(
    legend.position = "right",
    plot.title = element_markdown(size = 14),
    axis.title.y = element_text(size = 9),
    axis.title.x = element_text(size = 9),
    axis.text.x = element_text(size = 9),
    axis.text.y = element_text(size = 9),
    legend.text = element_text(size = 9),
    legend.title = element_blank()
  ) +
  ggplot2::facet_wrap(~variable)
```

# Next steps

-   [ ] Fine tuning for rates (esp. people aged 80 years and older)
-   [ ] Evaluation for subregions (in progress) -> computation speed?
-   [ ] Code cleaning, function-feedback, package tests
