test_that("compute_measures snapshots", {
  options(cli.default_handler = function(...) { })

  skip_on_ci()

  # Prepare data ----
  # Based on data created in prepare_measures
  # nolint start
  # combined_snapshot |>
  #   constructive::construct()
  # nolint end
  combined <- tibble::tibble(
    year = rep(2020L, 404L),
    spatial_unit = rep("Aargau", 404L),
    nat = rep(c("ch", "int"), each = 202L),
    sex = rep(rep(c("m", "f"), 2), each = 101L),
    age = rep(seq(0, 100, by = 1), 4),
    n_benchmark = c(
      2605, 2679, 2650, 2688, 2637, 2721, 2764, 2672, 2651, 2666, 2700, 2581, 2636,
      2521, 2615, 2631, 2652, 2677, 2647, 2612, 2870, 2783, 2870, 2912, 3036, 2851,
      2945, 3026, 3135, 3070, 3094, 3107, 3060, 3012, 3132, 2970, 3155, 3101, 3161,
      3129, 3141, 3022, 2952, 2963, 2823, 2926, 3132, 3119, 3318, 3475, 3665, 3713,
      4022, 4113, 4149, 4247, 4271, 4109, 4103, 3997, 3778, 3696, 3583, 3578, 3409,
      3345, 3178, 3102, 2989, 2774, 2810, 2717, 2735, 2650, 2604, 2443, 2322, 2216,
      1956, 1765, 1402, 1335, 1319, 1141, 1030, 956, 883, 692, 629, 525, 439, 329,
      258, 174, 108, 82, 61, 39, 32, 10, 11, 2367, 2452, 2499, 2580, 2575, 2560,
      2504, 2481, 2538, 2478, 2619, 2475, 2564, 2426, 2453, 2427, 2506, 2482, 2503,
      2531, 2610, 2668, 2690, 2850, 2864, 2928, 2900, 2858, 3130, 3065, 3134, 3007,
      3081, 3074, 3078, 3028, 3104, 3122, 3251, 3275, 3102, 3069, 2952, 3041, 3223,
      3089, 3135, 3171, 3347, 3646, 3840, 3908, 4182, 4192, 4291, 4295, 4417, 4323,
      4135, 4080, 3986, 3816, 3822, 3797, 3600, 3495, 3351, 3241, 3241, 3029, 3049,
      2954, 2895, 2837, 2805, 2707, 2639, 2557, 2278, 2059, 1826, 1769, 1700, 1562,
      1562, 1346, 1317, 1145, 1105, 909, 828, 679, 560, 440, 354, 255, 189, 134, 97,
      61, 55, 995, 1065, 1081, 1054, 1156, 1056, 1048, 1036, 1098, 1040, 978, 954,
      1027, 905, 887, 918, 837, 812, 801, 753, 847, 855, 973, 1052, 1138, 1142,
      1292, 1462, 1536, 1644, 1834, 1842, 1867, 1954, 1899, 1987, 2075, 2027, 2098,
      2077, 1987, 1907, 1931, 1869, 1847, 1729, 1665, 1641, 1656, 1580, 1494, 1568,
      1500, 1540, 1518, 1536, 1481, 1365, 1207, 1132, 1093, 901, 865, 757, 712, 632,
      537, 468, 454, 427, 471, 393, 401, 354, 349, 272, 304, 302, 314, 249, 299,
      233, 218, 161, 162, 120, 83, 59, 45, 31, 28, 29, 16, 15, 4, 6, 2, 2, 1, 0, 1,
      1002, 1008, 981, 956, 1035, 977, 1005, 979, 984, 870, 1008, 908, 881, 845,
      827, 856, 782, 721, 662, 630, 685, 697, 832, 887, 995, 1063, 1134, 1291, 1409,
      1546, 1604, 1590, 1668, 1717, 1789, 1809, 1786, 1818, 1819, 1752, 1758, 1621,
      1647, 1541, 1474, 1503, 1444, 1364, 1422, 1324, 1222, 1270, 1214, 1206, 1191,
      1095, 1116, 1010, 910, 859, 850, 744, 665, 593, 546, 523, 501, 434, 410, 384,
      370, 362, 373, 288, 298, 243, 262, 219, 249, 235, 242, 231, 179, 178, 122,
      117, 84, 90, 49, 48, 36, 28, 21, 23, 12, 6, 5, 7, 1, 2, 3
    ),
    n_projected = c(
      2526, 2558, 2594, 2667, 2645, 2698, 2764, 2657, 2616, 2653, 2678, 2564, 2626,
      2478, 2586, 2614, 2638, 2646, 2608, 2579, 2861, 2792, 2884, 2951, 3037, 2877,
      2914, 3029, 3103, 3059, 3074, 3086, 3022, 2995, 3106, 2999, 3191, 3102, 3143,
      3131, 3122, 3029, 2938, 2979, 2830, 2899, 3129, 3107, 3273, 3481, 3631, 3720,
      4022, 4103, 4140, 4211, 4273, 4103, 4080, 3978, 3742, 3694, 3584, 3591, 3438,
      3395, 3199, 3087, 2996, 2790, 2812, 2728, 2744, 2652, 2615, 2457, 2333, 2235,
      1996, 1777, 1425, 1338, 1340, 1159, 1040, 962, 913, 724, 669, 555, 457, 366,
      299, 206, 155, 109, 68, 51, 31, 14, 13, 2420, 2436, 2459, 2552, 2597, 2562,
      2462, 2449, 2523, 2433, 2590, 2443, 2522, 2380, 2438, 2397, 2499, 2496, 2509,
      2524, 2575, 2669, 2671, 2811, 2867, 2885, 2922, 2874, 3119, 3017, 3079, 3005,
      3059, 3057, 3045, 3010, 3057, 3112, 3263, 3267, 3098, 3069, 2961, 3049, 3210,
      3092, 3142, 3164, 3351, 3656, 3844, 3901, 4146, 4161, 4287, 4300, 4383, 4311,
      4126, 4086, 3994, 3820, 3813, 3810, 3597, 3497, 3349, 3259, 3266, 3015, 3043,
      2953, 2908, 2834, 2830, 2725, 2654, 2565, 2294, 2077, 1839, 1781, 1696, 1575,
      1553, 1379, 1326, 1174, 1117, 956, 860, 708, 607, 442, 366, 274, 185, 124, 78,
      45, 40, 1118, 1105, 1043, 1053, 1150, 1057, 1067, 1070, 1127, 1069, 1004, 982,
      1026, 941, 906, 943, 863, 837, 809, 774, 844, 880, 1003, 1056, 1158, 1210,
      1309, 1490, 1572, 1649, 1827, 1859, 1873, 1928, 1913, 1994, 2029, 2001, 2090,
      2062, 2005, 1880, 1885, 1858, 1812, 1729, 1658, 1620, 1678, 1590, 1540, 1578,
      1513, 1574, 1535, 1564, 1526, 1365, 1206, 1145, 1110, 947, 881, 777, 729, 650,
      567, 490, 476, 442, 470, 398, 399, 369, 354, 280, 309, 308, 310, 249, 297,
      242, 211, 159, 165, 122, 96, 60, 49, 33, 33, 28, 16, 16, 6, 5, 2, 1, 1, 1, 2,
      1052, 1040, 959, 973, 1035, 1001, 1009, 981, 1011, 936, 1022, 959, 927, 900,
      874, 882, 833, 746, 710, 669, 730, 744, 857, 935, 1024, 1112, 1149, 1283,
      1415, 1525, 1558, 1593, 1640, 1701, 1727, 1788, 1807, 1752, 1766, 1753, 1757,
      1635, 1632, 1532, 1509, 1519, 1439, 1388, 1437, 1348, 1265, 1300, 1236, 1225,
      1189, 1117, 1116, 1017, 904, 846, 873, 752, 670, 595, 562, 537, 509, 434, 412,
      386, 378, 367, 382, 292, 301, 238, 267, 221, 254, 232, 238, 230, 189, 169,
      124, 122, 88, 81, 55, 51, 36, 26, 22, 20, 13, 6, 7, 7, 2, 3, 1
    ),
  )

  # # Based on data created in prepare_measures
  # nolint start
  # combined_grouped_snapshot |>
  #   constructive::construct()
  # nolint end

  combined_grouped <- tibble::tibble(
    year = rep(2020L, 12L),
    spatial_unit = rep("Aargau", 12L),
    age = rep(c("age_00_19", "age_20_64", "age_65_"), each = 4L),
    sex = rep(rep(c("f", "m"), 3), each = 2L),
    nat = rep(c("ch", "int"), 6),
    n_benchmark = c(50020, 17917, 53005, 19501, 152176, 57480, 149723, 68082, 61030, 6635, 51061, 7442),
    n_projected = c(49691, 18519, 52395, 19944, 151735, 57722, 149453, 68452, 61394, 6700, 51710, 7616),
  )

  # Tests ----
  snapshot1 <- compute_measures(combined)
  expect_snapshot(constructive::construct(snapshot1))

  snapshot2 <- compute_measures(combined, weight_groups = c("age", "nat"))
  expect_snapshot(constructive::construct(snapshot2))

  snapshot3 <- compute_measures(combined_grouped)
  expect_snapshot(constructive::construct(snapshot3))

  snapshot4 <- compute_measures(combined_grouped, weight_groups = c("age", "nat"))
  expect_snapshot(constructive::construct(snapshot4))
})
