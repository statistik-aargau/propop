# Runs tests for projections with 2 nationalities
# Tests with only 1 nationality are part of test-single-nationality

options(cli.default_handler = function(...) { })

# Run simple test on ci
test_that("Simple propop test for ci", {
  expect_snapshot(dput(
    propop(
      parameters = fso_parameters |>
        dplyr::filter(scen == "reference"),
      year_first = 2024,
      year_last = 2024,
      population = fso_population,
      subregional = FALSE,
      binational = TRUE
    )
  ))
}
)

# Ensure that N_high > N_reference > N_low

test_that("N_totals of scenarios are ordered plausibly", {

  n_ordered <- propop(
    parameters = fso_parameters,
    year_first = 2024,
    year_last = 2025,
    population = fso_population,
    subregional = FALSE,
    binational = TRUE
  ) |>
    # Get end total per scenario
    filter(year == 2025)  |>
    summarise(total = sum(n_dec), .by = "scen")

  n_high <- n_ordered |>
    filter(scen == "high") |>
    pull(total)

  n_reference <- n_ordered |>
    filter(scen == "reference") |>
    pull(total)

  n_low <- n_ordered |>
    filter(scen == "low") |>
    pull(total)

  expect_gt(n_high, n_reference)
  expect_gt(n_reference, n_low)
})


# Prepare snapshot 1 region ----

test_that("tests propop: 1 region vs. 5 regions", {

  skip_on_ci()

  ## FSO parameters ----
  # fso_parameters |>
  #   dplyr::filter(year == 2024 & scen == "reference") |>
  #   constructive::construct()

  parameters_short_1r <- tibble::tibble(
    nat = rep(c("ch", "int"), each = 202L),
    sex = rep(rep(c("m", "f"), 2), each = 101L),
    age = rep(seq(0, 100, by = 1), 4),
    start_n = c(
      0, 2366, 2542, 2891, 2766, 2794, 2782, 2787, 2726, 2837, 2866, 2760, 2766,
      2799, 2823, 2707, 2768, 2660, 2744, 2760, 2767, 2730, 2686, 2639, 2872, 2812,
      2874, 2899, 3060, 2823, 2844, 3085, 3189, 3162, 3192, 3193, 3197, 3164, 3262,
      3130, 3280, 3263, 3300, 3269, 3288, 3131, 3091, 3087, 2931, 3008, 3194, 3242,
      3371, 3555, 3707, 3773, 4028, 4106, 4133, 4231, 4286, 4070, 4041, 3910, 3716,
      3609, 3443, 3416, 3277, 3219, 3054, 2977, 2865, 2641, 2672, 2552, 2582, 2485,
      2406, 2246, 2115, 2001, 1715, 1556, 1204, 1100, 1064, 915, 746, 688, 587, 446,
      389, 302, 234, 153, 118, 75, 35, 33, 38, 0, 2277, 2434, 2685, 2533, 2577,
      2609, 2671, 2660, 2642, 2599, 2580, 2653, 2600, 2763, 2581, 2683, 2549, 2564,
      2526, 2611, 2569, 2553, 2548, 2661, 2766, 2723, 2845, 2866, 2891, 2946, 2936,
      3186, 3172, 3268, 3149, 3267, 3238, 3240, 3184, 3288, 3272, 3375, 3408, 3272,
      3224, 3034, 3137, 3309, 3184, 3190, 3242, 3410, 3727, 3867, 3905, 4211, 4207,
      4307, 4287, 4399, 4297, 4143, 4054, 3949, 3751, 3732, 3716, 3524, 3425, 3272,
      3168, 3163, 2949, 2963, 2860, 2778, 2712, 2676, 2561, 2468, 2384, 2097, 1870,
      1638, 1556, 1432, 1275, 1259, 1059, 978, 806, 719, 560, 473, 378, 286, 203,
      148, 97, 149, 0, 920, 1120, 1157, 1137, 1159, 1189, 1143, 1228, 1121, 1162,
      1113, 1156, 1106, 1004, 1000, 1075, 954, 1076, 1064, 968, 919, 960, 986, 1162,
      1231, 1378, 1517, 1635, 1638, 1769, 1899, 1956, 2082, 2226, 2179, 2149, 2293,
      2244, 2248, 2321, 2216, 2254, 2236, 2176, 2087, 2051, 1928, 1878, 1784, 1726,
      1690, 1694, 1592, 1542, 1570, 1529, 1532, 1506, 1501, 1415, 1272, 1132, 1021,
      1008, 817, 753, 628, 592, 567, 495, 430, 403, 398, 441, 357, 369, 313, 310,
      242, 281, 264, 275, 208, 234, 202, 167, 119, 124, 95, 58, 41, 19, 18, 11, 16,
      7, 3, 0, 0, 1, 0, 898, 974, 1100, 1145, 1094, 1075, 1049, 1128, 1064, 1089,
      1023, 1039, 933, 1023, 958, 920, 884, 808, 832, 798, 766, 780, 818, 948, 1028,
      1162, 1317, 1382, 1515, 1571, 1668, 1792, 1808, 1919, 1913, 1958, 1966, 1986,
      2002, 1972, 1966, 1986, 1912, 1873, 1714, 1776, 1634, 1542, 1568, 1485, 1392,
      1481, 1390, 1281, 1303, 1220, 1223, 1181, 1079, 1098, 981, 876, 824, 827, 696,
      640, 541, 510, 517, 500, 445, 403, 382, 374, 360, 374, 263, 292, 231, 241,
      199, 234, 207, 226, 204, 156, 152, 94, 93, 60, 60, 34, 30, 21, 21, 13, 10, 4,
      3, 3
    ),
    year = rep(2024, 404L),
    scen = rep("reference", 404L),
    spatial_unit = rep("Aargau", 404L),
    birthrate = rep(
      c(
        0, 0.000786, 0.001525, 0.003106, 0.005874, 0.010611, 0.01731, 0.026459,
        0.037882, 0.051065, 0.066655, 0.082599, 0.099543, 0.11384, 0.123888, 0.127307,
        0.121966, 0.108771, 0.090344, 0.070041, 0.050405, 0.034815, 0.022905,
        0.014548, 0.00941, 0.006123, 0.003948, 0.002777, 0.001967, 0.00127, 0.001205,
        0.000939, 0, 0.001146, 0.005, 0.010856, 0.018645, 0.029318, 0.040665,
        0.053519, 0.067371, 0.082407, 0.097902, 0.110989, 0.126001, 0.135507,
        0.141002, 0.141603, 0.136799, 0.127822, 0.115256, 0.100284, 0.084536,
        0.069715, 0.055096, 0.04232, 0.031369, 0.022854, 0.016109, 0.01098, 0.006943,
        0.004665, 0.002817, 0.001224, 0.000648, 0.000638, 0
      ),
      rep(c(120L, 1L, 169L, 1L, 51L), c(1L, 31L, 1L, 33L, 1L))
    ),
    int_mothers = rep(0.24983410749834106, 404L),
    mor = c(
      0.003628, 0.000415, 0.000389, 0.000343, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0.000358, 0.000373, 0.000362, 0.000362, 0.000362, 0.000367, 0.000372,
      0.000379, 0.000349, 0.000357, 0.000349, 0.000346, 0.000328, 0.000354, 0.00035,
      0.000646, 0.000623, 0.000627, 0.000621, 0.000621, 0.00062, 0.000626, 0.000608,
      0.000633, 0.000605, 0.000609, 0.000903, 0.000911, 0.000907, 0.000952,
      0.001286, 0.001288, 0.001357, 0.001653, 0.00187, 0.00215, 0.002068, 0.002523,
      0.00269, 0.003172, 0.003469, 0.003891, 0.004107, 0.004486, 0.005131, 0.005402,
      0.005937, 0.006391, 0.006998, 0.007502, 0.00813, 0.008781, 0.009461, 0.010567,
      0.011466, 0.012435, 0.013969, 0.01553, 0.017222, 0.0196, 0.022468, 0.025765,
      0.029516, 0.034283, 0.039716, 0.0455, 0.053061, 0.061054, 0.070598, 0.08,
      0.092149, 0.103825, 0.116622, 0.129267, 0.141277, 0.152466, 0.164313,
      0.182119, 0.200855, 0.228013, 0.254237, 0.28, 0.314286, 0.333333, 0.394737,
      0.002957, 0.000433, 0.000407, 0.000369, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0.000376, 0.000362, 0.000368, 0.000352, 0.000349,
      0.000346, 0.000339, 0.000339, 0.000312, 0.000313, 0.000303, 0.000314,
      0.000303, 0.000306, 0.000305, 0.000311, 0.000603, 0.000606, 0.000588,
      0.000583, 0.000607, 0.000617, 0.000655, 0.000952, 0.000903, 0.001252,
      0.001249, 0.00123, 0.001462, 0.001606, 0.001807, 0.002045, 0.002135, 0.002376,
      0.002553, 0.002798, 0.003181, 0.003489, 0.00386, 0.004192, 0.004563, 0.005067,
      0.005627, 0.00592, 0.006528, 0.0073, 0.007949, 0.00884, 0.009802, 0.010855,
      0.012154, 0.013641, 0.015482, 0.01733, 0.019806, 0.022647, 0.025932, 0.029788,
      0.034803, 0.040631, 0.046994, 0.055252, 0.064921, 0.076078, 0.089718,
      0.103774, 0.120531, 0.137546, 0.155556, 0.174844, 0.19641, 0.216931, 0.240838,
      0.265356, 0.283784, 0.309278, 0.362416, 0.003417, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0.000935, 0.001049, 0.00093, 0.000929, 0.001011, 0.001056,
      0.001005, 0.000973, 0.000827, 0.000779, 0.000699, 0.000636, 0.000592,
      0.000589, 0.000548, 0.000512, 0.000498, 0.00047, 0.000441, 0.000451, 0.000457,
      0.00043, 0.00044, 0.00044, 0.000428, 0.000896, 0.000883, 0.000892, 0.000917,
      0.000956, 0.000974, 0.001036, 0.001063, 0.00168, 0.001735, 0.001775, 0.001771,
      0.001885, 0.001947, 0.002555, 0.002627, 0.00263, 0.003351, 0.003362, 0.004287,
      0.004752, 0.005352, 0.005961, 0.007085, 0.0076, 0.00953, 0.009646, 0.011895,
      0.012411, 0.014213, 0.016355, 0.017456, 0.020202, 0.020525, 0.022504, 0.02449,
      0.025641, 0.029126, 0.029046, 0.0322, 0.034221, 0.036563, 0.043269, 0.047009,
      0.054455, 0.066066, 0.075949, 0.089069, 0.116402, 0.137931, 0.195122,
      0.210526, 0.277778, 0.272727, 0.3125, 0.285714, 0.333333, 0, 0, 1, 0.002676,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0.000822, 0.00073, 0.000696, 0.000639, 0.000618, 0.000585, 0.000547, 0.000544,
      0.000514, 0.000517, 0.000506, 0.000505, 0.000501, 0.000498, 0.000506,
      0.000508, 0.000503, 0.000523, 0.000534, 0.000583, 0.000563, 0.000612,
      0.000647, 0.001276, 0.001345, 0.001434, 0.00135, 0.001437, 0.001559, 0.002304,
      0.002463, 0.002465, 0.002559, 0.002808, 0.002766, 0.003094, 0.003464,
      0.003686, 0.004914, 0.004342, 0.004717, 0.005566, 0.005894, 0.007759,
      0.008032, 0.009019, 0.00995, 0.010471, 0.01071, 0.013908, 0.013387, 0.015209,
      0.017153, 0.021692, 0.024948, 0.025126, 0.029979, 0.033816, 0.044346, 0.0489,
      0.057692, 0.072607, 0.085106, 0.096774, 0.116667, 0.133333, 0.147059,
      0.169492, 0.190476, 0.190476, 0.230769, 0.3, 0.25, 0.333333, 0.333333
    ),
    emi_int = c(
      0.001218, 0.004649, 0.004327, 0.004151, 0.003977, 0.003579, 0.003595,
      0.003229, 0.002935, 0.00282, 0.002442, 0.002174, 0.001808, 0.001786, 0.001417,
      0.001478, 0.001445, 0.00188, 0.002551, 0.003261, 0.003975, 0.004396, 0.00484,
      0.005305, 0.005919, 0.006046, 0.005915, 0.005864, 0.005882, 0.005313,
      0.005274, 0.004862, 0.004704, 0.004428, 0.004386, 0.004385, 0.004066,
      0.003793, 0.003679, 0.003514, 0.003354, 0.003371, 0.00303, 0.003059, 0.003041,
      0.002874, 0.002912, 0.002592, 0.002729, 0.00266, 0.002818, 0.002776, 0.002966,
      0.003094, 0.003237, 0.003446, 0.003972, 0.00414, 0.004355, 0.004727, 0.0049,
      0.004668, 0.004454, 0.003836, 0.003767, 0.005819, 0.004647, 0.003513,
      0.003357, 0.003107, 0.00262, 0.002351, 0.002094, 0.001893, 0.001497, 0.001567,
      0.001162, 0.001207, 0.000831, 0.00089, 0.000946, 0.001, 0.000583, 0.000643,
      0.000831, 0.000909, 0.00094, 0.001093, 0.00134, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0.002559, 0.004831, 0.00493, 0.004469, 0.004343, 0.004269, 0.00345,
      0.00337, 0.003008, 0.00265, 0.002309, 0.002326, 0.001885, 0.001538, 0.001448,
      0.00155, 0.001491, 0.001962, 0.00234, 0.002771, 0.003447, 0.004282, 0.0047,
      0.005102, 0.005637, 0.005423, 0.005509, 0.005624, 0.005234, 0.005189,
      0.004752, 0.004768, 0.004394, 0.004098, 0.003978, 0.003811, 0.003673,
      0.003397, 0.003086, 0.002827, 0.002737, 0.002751, 0.002667, 0.002641,
      0.002445, 0.002481, 0.002637, 0.00255, 0.00272, 0.002827, 0.002821, 0.003085,
      0.003519, 0.003488, 0.00362, 0.003585, 0.003562, 0.003565, 0.003483, 0.003266,
      0.003183, 0.003025, 0.003138, 0.00296, 0.003292, 0.002399, 0.002144, 0.001615,
      0.001135, 0.000876, 0.000917, 0.000631, 0.000632, 0.000678, 0.000675,
      0.000699, 0.00072, 0.000369, 0.000374, 0.00039, 0.000405, 0.000419, 0.000477,
      0.000535, 0.000611, 0.000643, 0.000698, 0.000784, 0.000794, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0.007772, 0.036957, 0.03125, 0.026793, 0.021988, 0.019845,
      0.017662, 0.014873, 0.013029, 0.010705, 0.010327, 0.008985, 0.008651,
      0.007233, 0.006972, 0.006, 0.006512, 0.006289, 0.010223, 0.014098, 0.018595,
      0.025027, 0.029167, 0.034483, 0.037005, 0.03818, 0.039187, 0.036915, 0.037309,
      0.03602, 0.035048, 0.033702, 0.03272, 0.0317, 0.030548, 0.02983, 0.029316,
      0.027911, 0.027629, 0.02669, 0.026282, 0.025271, 0.024845, 0.02415, 0.024357,
      0.023, 0.022428, 0.021784, 0.021299, 0.02074, 0.019699, 0.020118, 0.019481,
      0.019472, 0.020104, 0.021019, 0.022237, 0.024804, 0.02656, 0.025316, 0.028269,
      0.021226, 0.025618, 0.033301, 0.043651, 0.073439, 0.054449, 0.023885,
      0.015203, 0.014109, 0.012121, 0.011628, 0.012407, 0.012563, 0.011338,
      0.011204, 0.01084, 0.009585, 0.009677, 0.008264, 0.007117, 0.003788, 0.007273,
      0.004808, 0.004274, 0.00495, 0.005988, 0.008403, 0.008065, 0.010526, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0.003626, 0.028953, 0.026694, 0.025455, 0.023581,
      0.021024, 0.018605, 0.017159, 0.014184, 0.013158, 0.011938, 0.01173, 0.01155,
      0.010718, 0.010753, 0.011482, 0.01087, 0.011312, 0.013614, 0.014423, 0.015038,
      0.018277, 0.019231, 0.022005, 0.024262, 0.026265, 0.026678, 0.025816,
      0.025326, 0.026403, 0.026098, 0.025779, 0.024554, 0.023783, 0.022408,
      0.021432, 0.019918, 0.01882, 0.01712, 0.016484, 0.015213, 0.014751, 0.013595,
      0.013075, 0.01228, 0.012252, 0.011824, 0.011628, 0.011025, 0.010842, 0.010774,
      0.010057, 0.010128, 0.010072, 0.010929, 0.013047, 0.015574, 0.018806,
      0.022862, 0.026877, 0.030965, 0.029562, 0.02968, 0.03034, 0.038694, 0.022989,
      0.021875, 0.016636, 0.013725, 0.01354, 0.012, 0.011236, 0.012407, 0.010471,
      0.010695, 0.011111, 0.010695, 0.011407, 0.013699, 0.012987, 0.012448, 0.01005,
      0.012821, 0.009662, 0.013274, 0.009804, 0.012821, 0.013158, 0.010638,
      0.010753, 0.016667, 0.016667, 0.029412, 0.033333, 0, 0, 0, 0, 0, 0, 0
    ),
    emi_nat = c(
      0.008526, 0.02071, 0.02203, 0.018679, 0.015907, 0.013601, 0.011862, 0.010405,
      0.008804, 0.007755, 0.006978, 0.006159, 0.005423, 0.004645, 0.004251,
      0.004064, 0.003974, 0.005263, 0.008382, 0.013043, 0.01807, 0.024176, 0.030901,
      0.038272, 0.045613, 0.05192, 0.056019, 0.057951, 0.057516, 0.054906, 0.051336,
      0.047002, 0.042333, 0.037951, 0.033835, 0.030379, 0.027213, 0.024652,
      0.022379, 0.020447, 0.018902, 0.017775, 0.016364, 0.015601, 0.014599,
      0.014053, 0.013264, 0.012634, 0.012282, 0.011636, 0.011271, 0.010796,
      0.010383, 0.010127, 0.009711, 0.009276, 0.008937, 0.008768, 0.008468,
      0.008036, 0.007933, 0.007617, 0.007424, 0.007161, 0.00915, 0.012746, 0.00639,
      0.00644, 0.006103, 0.005902, 0.005894, 0.00571, 0.005585, 0.005301, 0.00524,
      0.005094, 0.005035, 0.004829, 0.004572, 0.004452, 0.004255, 0.004498,
      0.004082, 0.003856, 0.004153, 0.003636, 0.003759, 0.003279, 0.004021,
      0.002907, 0.003407, 0.004484, 0.002571, 0.003311, 0.004274, 0, 0, 0, 0, 0, 0,
      0.009382, 0.028107, 0.023007, 0.018994, 0.015792, 0.013194, 0.011115, 0.00936,
      0.008271, 0.007192, 0.006541, 0.005814, 0.005654, 0.005385, 0.005429,
      0.005424, 0.006336, 0.008239, 0.01209, 0.018606, 0.027959, 0.038926, 0.05092,
      0.061617, 0.069899, 0.074837, 0.076019, 0.074165, 0.069784, 0.063646,
      0.057026, 0.049728, 0.043315, 0.037201, 0.031824, 0.027628, 0.023875,
      0.021001, 0.018519, 0.016646, 0.015511, 0.014364, 0.013333, 0.012617,
      0.012225, 0.011787, 0.011536, 0.011157, 0.010879, 0.010678, 0.010345,
      0.010179, 0.009971, 0.009928, 0.009827, 0.009475, 0.009261, 0.009033,
      0.008823, 0.008631, 0.008411, 0.008378, 0.007965, 0.007893, 0.009876,
      0.009064, 0.007235, 0.006997, 0.00681, 0.006423, 0.006418, 0.005997, 0.005691,
      0.005765, 0.0054, 0.005245, 0.00504, 0.004794, 0.004484, 0.004295, 0.004052,
      0.004195, 0.003815, 0.003743, 0.003663, 0.003213, 0.002793, 0.003137,
      0.002383, 0.002833, 0.002045, 0.002481, 0.001391, 0.001786, 0.002114,
      0.002646, 0, 0, 0, 0, 0, 0.005181, 0.023913, 0.021429, 0.019879, 0.01759,
      0.015531, 0.014298, 0.012248, 0.011401, 0.009813, 0.008606, 0.008086, 0.00692,
      0.006329, 0.00498, 0.005, 0.004651, 0.006289, 0.010223, 0.016917, 0.025826,
      0.03482, 0.044792, 0.052738, 0.05852, 0.062551, 0.064586, 0.06526, 0.06422,
      0.062271, 0.059921, 0.056872, 0.054192, 0.050913, 0.048068, 0.044975,
      0.042345, 0.039686, 0.037879, 0.035587, 0.034037, 0.032942, 0.0315, 0.030859,
      0.029871, 0.029229, 0.028279, 0.02749, 0.027157, 0.026345, 0.025492, 0.024852,
      0.023613, 0.022613, 0.021401, 0.020382, 0.019621, 0.018277, 0.017264,
      0.015989, 0.014841, 0.013365, 0.012367, 0.011753, 0.010913, 0.011016,
      0.010624, 0.009554, 0.008446, 0.007055, 0.006061, 0.006977, 0.004963,
      0.005025, 0.004535, 0.002801, 0.00271, 0.003195, 0.003226, 0.004132, 0.003559,
      0.003788, 0.003636, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0.003626, 0.024499, 0.021561, 0.019091, 0.017467, 0.015539, 0.013953,
      0.012393, 0.011525, 0.010338, 0.009183, 0.00782, 0.0077, 0.006431, 0.005865,
      0.005219, 0.005435, 0.007919, 0.013614, 0.02524, 0.038847, 0.050914, 0.060256,
      0.066015, 0.068565, 0.067121, 0.065404, 0.061503, 0.057164, 0.052805,
      0.048377, 0.044365, 0.040737, 0.037058, 0.033872, 0.030842, 0.028601,
      0.025941, 0.024169, 0.022478, 0.021298, 0.019837, 0.019134, 0.018305,
      0.018153, 0.017503, 0.017455, 0.017136, 0.016861, 0.017219, 0.016835,
      0.016523, 0.01688, 0.016547, 0.015613, 0.015349, 0.014754, 0.014718, 0.013548,
      0.012975, 0.01184, 0.011213, 0.010274, 0.008495, 0.007255, 0.005747, 0.004688,
      0.003697, 0.003922, 0.003868, 0.004, 0.004494, 0.002481, 0.002618, 0.002674,
      0.002778, 0.002674, 0.003802, 0.003425, 0.004329, 0.004149, 0.005025,
      0.004274, 0.004831, 0.004425, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    ),
    acq = rep(
      c(
        0, 0.011957, 0.014286, 0.014693, 0.014952, 0.015531, 0.016821, 0.016623,
        0.019544, 0.022302, 0.024957, 0.028751, 0.033737, 0.037975, 0.041833, 0.045,
        0.046512, 0.045073, 0.040892, 0.020677, 0.017562, 0.016322, 0.014583,
        0.013185, 0.011188, 0.009748, 0.008708, 0.00791, 0.007339, 0.007326, 0.006783,
        0.007372, 0.007669, 0.008165, 0.008985, 0.010096, 0.010703, 0.011339,
        0.012032, 0.013345, 0.013356, 0.013538, 0.014197, 0.014311, 0.014706,
        0.014375, 0.014139, 0.014523, 0.013312, 0.013453, 0.012746, 0.012426,
        0.011806, 0.011307, 0.011025, 0.010191, 0.00981, 0.009138, 0.009296, 0.008661,
        0.007774, 0.007075, 0.007067, 0.006856, 0.005952, 0.00612, 0.005312, 0.004777,
        0.005068, 0.003527, 0.00404, 0.004651, 0.002481, 0.002513, 0.002268, 0.002801,
        0.00271, 0.003195, 0.003226, 0.004132, 0.003559, 0.003788, 0.003636, 0,
        0.020045, 0.019507, 0.017273, 0.015721, 0.015539, 0.015814, 0.017159,
        0.018617, 0.021617, 0.024793, 0.029326, 0.033686, 0.038585, 0.044966,
        0.049061, 0.051087, 0.050905, 0.045792, 0.038462, 0.033835, 0.028721,
        0.024359, 0.020782, 0.017932, 0.015564, 0.012048, 0.01063, 0.008683, 0.008581,
        0.008912, 0.009592, 0.010603, 0.012721, 0.013549, 0.015159, 0.015322,
        0.016277, 0.01712, 0.017483, 0.018256, 0.018311, 0.018127, 0.017782, 0.017619,
        0.017503, 0.016892, 0.016524, 0.015564, 0.015306, 0.014141, 0.013649,
        0.012829, 0.01223, 0.01171, 0.010744, 0.009016, 0.008177, 0.007621, 0.007414,
        0.006375, 0.006116, 0.005708, 0.004854, 0.003628, 0.00431, 0.003125, 0.003697,
        0.001961, 0.001934, 0.002, 0.002247, 0.002481, 0
      ),
      rep(c(203L, 1L, 19L, 1L, 28L), c(1L, 82L, 1L, 72L, 1L))
    ),
    imm_int_n = c(
      4, 48, 17, 15, 14, 14, 14, 13, 12, 11, 10, 9, 8, 7, 6, 6, 5, 5, 5, 6, 8, 9,
      11, 12, 13, 14, 14, 14, 14, 13, 13, 13, 13, 13, 13, 13, 13, 12, 12, 12, 11,
      11, 10, 10, 9, 9, 8, 8, 8, 8, 9, 9, 10, 11, 11, 12, 12, 11, 11, 11, 10, 9, 9,
      9, 8, 7, 7, 7, 6, 6, 6, 5, 5, 5, 4, 4, 4, 3, 3, 3, 3, 2, 2, 2, 2, 1, 1, 1, 1,
      1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 44, 14, 13, 13, 12, 11, 10, 9, 8, 8, 7,
      6, 6, 6, 6, 6, 7, 6, 6, 7, 8, 9, 9, 10, 11, 12, 13, 13, 13, 13, 13, 14, 14,
      13, 13, 12, 12, 12, 11, 11, 10, 9, 8, 8, 7, 7, 7, 6, 6, 6, 7, 7, 7, 7, 7, 6,
      6, 6, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, 4, 4, 4, 4, 3, 3, 3, 3, 3, 2, 2, 2, 2,
      2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 14, 113, 53, 50, 49, 47,
      46, 46, 45, 44, 44, 44, 43, 42, 40, 38, 38, 40, 47, 58, 72, 89, 107, 123, 138,
      149, 157, 162, 164, 163, 162, 158, 153, 147, 140, 134, 127, 120, 114, 107,
      101, 95, 90, 85, 80, 75, 71, 67, 64, 60, 57, 53, 50, 46, 43, 38, 34, 29, 25,
      22, 19, 16, 13, 11, 9, 8, 7, 6, 5, 4, 3, 3, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 16, 122, 53, 50, 48, 46,
      45, 44, 42, 41, 40, 40, 38, 37, 35, 33, 31, 30, 30, 37, 51, 71, 93, 112, 125,
      134, 138, 138, 135, 130, 124, 118, 111, 105, 98, 92, 86, 81, 76, 71, 66, 63,
      59, 55, 52, 49, 47, 44, 42, 40, 38, 36, 34, 32, 29, 27, 23, 21, 18, 15, 13,
      12, 10, 8, 7, 6, 5, 5, 4, 4, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
      1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0
    ),
    imm_nat_n = c(
      47, 88, 88, 79, 62, 49, 41, 35, 30, 26, 23, 21, 19, 17, 17, 16, 16, 17, 19,
      25, 34, 49, 69, 89, 110, 119, 130, 141, 151, 153, 158, 159, 160, 156, 147,
      135, 123, 110, 101, 91, 84, 75, 69, 64, 59, 55, 50, 47, 44, 43, 44, 42, 43,
      41, 40, 40, 41, 40, 41, 38, 37, 37, 34, 31, 33, 35, 29, 25, 21, 18, 15, 14,
      13, 11, 11, 10, 10, 9, 8, 8, 7, 6, 5, 5, 4, 4, 3, 3, 3, 2, 2, 2, 2, 1, 1, 1,
      0, 0, 0, 0, 0, 57, 81, 79, 75, 57, 47, 38, 32, 27, 23, 20, 17, 16, 14, 13, 12,
      14, 20, 32, 51, 73, 94, 115, 137, 168, 182, 189, 190, 190, 179, 171, 163, 157,
      145, 135, 122, 112, 99, 92, 83, 75, 67, 62, 55, 51, 45, 41, 39, 38, 37, 38,
      39, 41, 43, 43, 44, 44, 42, 42, 42, 43, 41, 39, 37, 35, 33, 28, 25, 21, 18,
      17, 15, 14, 13, 13, 12, 12, 11, 10, 10, 9, 8, 8, 7, 6, 5, 5, 4, 4, 4, 3, 3, 2,
      1, 1, 1, 1, 1, 0, 0, 0, 20, 28, 29, 29, 25, 23, 22, 21, 19, 18, 17, 15, 13,
      12, 12, 12, 12, 14, 18, 23, 31, 37, 48, 60, 79, 91, 103, 116, 122, 127, 132,
      136, 137, 135, 135, 132, 130, 121, 116, 111, 103, 96, 91, 84, 81, 73, 68, 62,
      58, 52, 49, 44, 42, 38, 36, 34, 32, 29, 27, 25, 22, 18, 16, 13, 12, 11, 9, 6,
      5, 4, 3, 3, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 19, 33, 33, 31, 27, 23, 21, 18, 16, 14, 12, 11, 9, 8, 7,
      6, 7, 9, 13, 22, 32, 41, 51, 60, 73, 82, 91, 97, 101, 103, 100, 98, 97, 90,
      86, 81, 75, 67, 62, 56, 52, 48, 44, 41, 38, 35, 34, 32, 30, 28, 27, 26, 25,
      25, 23, 22, 21, 18, 17, 15, 14, 11, 10, 8, 8, 7, 6, 4, 4, 3, 2, 2, 2, 2, 2, 2,
      2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    ),
    emi_nat_n = c(
      21, 49, 56, 54, 44, 38, 33, 29, 24, 22, 20, 17, 15, 13, 12, 11, 11, 14, 23,
      36, 50, 66, 83, 101, 131, 146, 161, 168, 176, 155, 146, 145, 135, 120, 108,
      97, 87, 78, 73, 64, 62, 58, 54, 51, 48, 44, 41, 39, 36, 35, 36, 35, 35, 36,
      36, 35, 36, 36, 35, 34, 34, 31, 30, 28, 34, 46, 22, 22, 20, 19, 18, 17, 16,
      14, 14, 13, 13, 12, 11, 10, 9, 9, 7, 6, 5, 4, 4, 3, 3, 2, 2, 2, 1, 1, 1, 0, 0,
      0, 0, 0, 0, 22, 64, 56, 51, 40, 34, 29, 25, 22, 19, 17, 15, 15, 14, 15, 14,
      17, 21, 31, 47, 73, 100, 130, 157, 186, 207, 207, 211, 200, 184, 168, 146,
      138, 118, 104, 87, 78, 68, 60, 53, 51, 47, 45, 43, 40, 38, 35, 35, 36, 34, 33,
      33, 34, 37, 38, 37, 39, 38, 38, 37, 37, 36, 33, 32, 39, 34, 27, 26, 24, 22,
      21, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 10, 8, 7, 6, 5, 4, 4, 3, 3, 2, 2,
      1, 1, 1, 1, 0, 0, 0, 0, 0, 6, 22, 24, 23, 20, 18, 17, 14, 14, 11, 10, 9, 8, 7,
      5, 5, 5, 6, 11, 18, 25, 32, 43, 52, 68, 77, 89, 99, 105, 102, 106, 108, 106,
      106, 107, 98, 91, 91, 85, 80, 79, 73, 71, 69, 65, 61, 58, 53, 51, 47, 44, 42,
      40, 36, 33, 32, 30, 28, 26, 24, 21, 17, 14, 12, 11, 9, 8, 6, 5, 4, 3, 3, 2, 2,
      2, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 4, 22, 21, 21, 20, 17, 15, 13, 13, 11, 10, 8, 8, 6, 6, 5, 5, 7, 11, 21, 31,
      39, 47, 54, 65, 69, 76, 81, 79, 80, 76, 74, 73, 67, 65, 59, 56, 51, 48, 45,
      42, 39, 38, 35, 34, 30, 31, 28, 26, 27, 25, 23, 25, 23, 20, 20, 18, 18, 16,
      14, 13, 11, 9, 7, 6, 4, 3, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
      1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    ),
    mig_nat_n = c(
      26, 39, 32, 25, 18, 11, 8, 6, 6, 4, 3, 4, 4, 4, 5, 5, 5, 3, -4, -11, -16, -17,
      -14, -12, -21, -27, -31, -27, -25, -2, 12, 14, 25, 36, 39, 38, 36, 32, 28, 27,
      22, 17, 15, 13, 11, 11, 9, 8, 8, 8, 8, 7, 8, 5, 4, 5, 5, 4, 6, 4, 3, 6, 4, 3,
      -1, -11, 7, 3, 1, -1, -3, -3, -3, -3, -3, -3, -3, -3, -3, -2, -2, -3, -2, -1,
      -1, 0, -1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 35, 17, 23, 24, 17, 13,
      9, 7, 5, 4, 3, 2, 1, 0, -2, -2, -3, -1, 1, 4, 0, -6, -15, -20, -18, -25, -18,
      -21, -10, -5, 3, 17, 19, 27, 31, 35, 34, 31, 32, 30, 24, 20, 17, 12, 11, 7, 6,
      4, 2, 3, 5, 6, 7, 6, 5, 7, 5, 4, 4, 5, 6, 5, 6, 5, -4, -1, 1, -1, -3, -4, -4,
      -4, -4, -4, -3, -3, -2, -2, -2, -1, -1, -2, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1,
      0, 0, 0, 1, 1, 0, 0, 0, 14, 6, 5, 6, 5, 5, 5, 7, 5, 7, 7, 6, 5, 5, 7, 7, 7, 8,
      7, 5, 6, 5, 5, 8, 11, 14, 14, 17, 17, 25, 26, 28, 31, 29, 28, 34, 39, 30, 31,
      31, 24, 23, 20, 15, 16, 12, 10, 9, 7, 5, 5, 2, 2, 2, 3, 2, 2, 1, 1, 1, 1, 1,
      2, 1, 1, 2, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0,
      0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 15, 11, 12, 10, 7, 6, 6, 5, 3, 3, 2, 3,
      1, 2, 1, 1, 2, 2, 2, 1, 1, 2, 4, 6, 8, 13, 15, 16, 22, 23, 24, 24, 24, 23, 21,
      22, 19, 16, 14, 11, 10, 9, 6, 6, 4, 5, 3, 4, 4, 1, 2, 3, 0, 2, 3, 2, 3, 0, 1,
      1, 1, 0, 1, 1, 2, 3, 3, 2, 2, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
      1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    ),
    fso_projection_n = c(
      2481, 2452, 2595, 2935, 2804, 2827, 2814, 2816, 2760, 2869, 2901, 2799, 2812,
      2847, 2872, 2759, 2823, 2705, 2781, 2767, 2764, 2724, 2683, 2637, 2859, 2793,
      2851, 2880, 3042, 2830, 2865, 3109, 3225, 3212, 3248, 3250, 3254, 3220, 3315,
      3186, 3331, 3308, 3344, 3311, 3327, 3169, 3124, 3119, 2960, 3035, 3218, 3263,
      3392, 3569, 3717, 3781, 4030, 4102, 4129, 4220, 4267, 4053, 4020, 3889, 3689,
      3562, 3417, 3387, 3245, 3182, 3016, 2937, 2822, 2598, 2624, 2500, 2523, 2419,
      2334, 2169, 2031, 1908, 1624, 1461, 1119, 1012, 965, 820, 659, 600, 505, 378,
      326, 247, 187, 119, 88, 54, 24, 22, 23, 2371, 2344, 2477, 2728, 2570, 2608,
      2637, 2697, 2687, 2670, 2631, 2613, 2690, 2638, 2809, 2628, 2729, 2595, 2602,
      2561, 2636, 2582, 2554, 2541, 2654, 2752, 2715, 2834, 2865, 2896, 2961, 2967,
      3223, 3222, 3324, 3213, 3330, 3301, 3307, 3250, 3348, 3327, 3426, 3451, 3314,
      3258, 3067, 3164, 3329, 3204, 3209, 3260, 3426, 3738, 3873, 3911, 4209, 4202,
      4300, 4280, 4390, 4286, 4131, 4040, 3922, 3730, 3711, 3694, 3500, 3399, 3244,
      3139, 3131, 2915, 2925, 2819, 2734, 2665, 2623, 2503, 2404, 2312, 2025, 1795,
      1562, 1471, 1340, 1178, 1147, 951, 862, 697, 609, 463, 381, 296, 218, 150,
      106, 67, 95, 1173, 994, 1127, 1165, 1149, 1170, 1199, 1160, 1238, 1135, 1172,
      1121, 1155, 1103, 1002, 994, 1062, 952, 1074, 1089, 1010, 974, 1029, 1069,
      1254, 1334, 1482, 1627, 1742, 1754, 1882, 2006, 2060, 2174, 2305, 2259, 2228,
      2352, 2299, 2295, 2353, 2246, 2274, 2248, 2185, 2094, 2055, 1932, 1882, 1785,
      1729, 1687, 1690, 1588, 1537, 1557, 1512, 1506, 1473, 1468, 1378, 1247, 1104,
      986, 961, 756, 709, 610, 578, 554, 483, 419, 392, 386, 427, 346, 357, 303,
      299, 233, 269, 253, 262, 199, 223, 191, 155, 109, 112, 83, 50, 33, 15, 13, 8,
      11, 5, 2, 0, 0, 0, 1127, 987, 994, 1113, 1155, 1106, 1089, 1062, 1136, 1071,
      1091, 1024, 1031, 926, 1002, 934, 896, 861, 792, 826, 811, 803, 843, 901,
      1041, 1132, 1269, 1422, 1491, 1614, 1663, 1750, 1863, 1869, 1968, 1956, 1993,
      1993, 2007, 2015, 1981, 1972, 1987, 1913, 1872, 1716, 1774, 1635, 1546, 1566,
      1486, 1396, 1479, 1391, 1282, 1298, 1213, 1208, 1161, 1055, 1068, 955, 853,
      801, 797, 683, 629, 534, 505, 510, 492, 438, 397, 378, 369, 354, 368, 259,
      286, 225, 234, 194, 226, 200, 215, 195, 147, 140, 86, 84, 53, 52, 29, 24, 17,
      17, 10, 7, 3, 2, 2
    ),
  )

  ## FSO population ----
  # fso_population |>
  #   constructive::construct()
  population_short_1r <- tibble::tibble(
    year = rep(2023, 404L),
    spatial_unit = rep("Aargau", 404L),
    nat = rep(c("ch", "int"), each = 202L),
    sex = rep(rep(c("m", "f"), 2), each = 101L),
    age = rep(seq(0, 100, by = 1), 4),
    n = c(
      2371, 2542, 2891, 2766, 2794, 2782, 2787, 2726, 2837, 2866, 2760, 2766, 2799,
      2823, 2707, 2768, 2660, 2744, 2759, 2767, 2730, 2686, 2639, 2872, 2812, 2874,
      2899, 3060, 2823, 2844, 3085, 3189, 3162, 3192, 3193, 3197, 3164, 3262, 3130,
      3280, 3263, 3300, 3269, 3288, 3131, 3091, 3087, 2931, 3008, 3194, 3242, 3371,
      3555, 3707, 3773, 4028, 4106, 4133, 4231, 4286, 4070, 4041, 3910, 3716, 3609,
      3443, 3416, 3277, 3219, 3054, 2977, 2865, 2641, 2672, 2552, 2582, 2485, 2406,
      2246, 2114, 2001, 1715, 1556, 1204, 1100, 1064, 915, 746, 688, 587, 446, 389,
      302, 234, 153, 118, 75, 35, 33, 15, 23, 2286, 2434, 2685, 2533, 2577, 2609,
      2671, 2660, 2642, 2599, 2580, 2653, 2600, 2763, 2581, 2683, 2549, 2564, 2527,
      2611, 2569, 2553, 2548, 2662, 2766, 2723, 2845, 2866, 2891, 2946, 2936, 3186,
      3172, 3268, 3149, 3267, 3238, 3240, 3184, 3288, 3272, 3375, 3408, 3272, 3224,
      3034, 3137, 3309, 3184, 3190, 3242, 3410, 3727, 3867, 3905, 4211, 4207, 4307,
      4287, 4399, 4297, 4143, 4054, 3949, 3751, 3732, 3716, 3524, 3425, 3272, 3168,
      3163, 2949, 2963, 2860, 2778, 2712, 2676, 2561, 2468, 2384, 2097, 1870, 1638,
      1556, 1432, 1275, 1259, 1059, 978, 806, 719, 560, 473, 378, 286, 203, 148, 97,
      67, 82, 945, 1123, 1157, 1137, 1159, 1189, 1143, 1228, 1121, 1162, 1113, 1156,
      1106, 1004, 1000, 1075, 954, 1076, 1064, 968, 919, 960, 986, 1162, 1231, 1378,
      1517, 1635, 1638, 1769, 1899, 1956, 2082, 2226, 2179, 2149, 2293, 2244, 2248,
      2321, 2216, 2253, 2236, 2176, 2086, 2051, 1928, 1879, 1784, 1726, 1690, 1694,
      1592, 1542, 1570, 1529, 1532, 1506, 1501, 1415, 1272, 1132, 1021, 1007, 817,
      753, 628, 592, 567, 495, 430, 403, 398, 440, 357, 369, 313, 310, 242, 281,
      263, 275, 208, 234, 202, 166, 118, 124, 95, 58, 41, 19, 18, 11, 16, 7, 3, 0,
      0, 0, 1, 928, 974, 1100, 1145, 1094, 1075, 1049, 1128, 1064, 1089, 1023, 1039,
      933, 1023, 958, 920, 884, 808, 832, 798, 766, 780, 818, 948, 1028, 1162, 1317,
      1382, 1515, 1571, 1668, 1792, 1808, 1919, 1913, 1958, 1966, 1986, 2002, 1973,
      1966, 1986, 1912, 1873, 1714, 1776, 1634, 1542, 1568, 1485, 1392, 1481, 1390,
      1281, 1303, 1220, 1223, 1181, 1079, 1098, 980, 876, 824, 827, 696, 640, 541,
      509, 517, 500, 445, 403, 382, 374, 360, 374, 263, 292, 230, 241, 199, 234,
      207, 226, 204, 156, 152, 93, 93, 60, 59, 34, 30, 21, 21, 13, 10, 4, 3, 1, 1
    ),
  )

  ## Run propop with 1 region ----
  output_propop_1r <- propop(
    parameters = parameters_short_1r,
    year_first = 2024,
    year_last = 2024,
    age_groups = 101,
    fert_first = 16,
    fert_last = 50,
    share_born_female = 100 / 205,
    population = population_short_1r,
    binational = TRUE,
    subregional = FALSE
  )

  # Run snapshot 1 region ----
  expect_snapshot(constructive::construct(output_propop_1r))



  # Prepare snapshot for 5 subregions -----

  ## FSO parameters with fictitious subregions ----
  # fso_parameters |>
  #   dplyr::filter(year == 2024 & scen == "reference") |>
  #   # Create fictitious intra-cantonal migration parameter
  #   dplyr::rowwise() |>
  #   dplyr::mutate(
  #     mig_sub_1 = {set.seed(1); round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_2 = {set.seed(2);round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_3 = {set.seed(3);round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_4 = {set.seed(4);round(rnorm(1, mean = 0, sd = 0.2), digits = 4)},
  #     mig_sub_5 = 0 - sum(mig_sub_1, mig_sub_2,mig_sub_3,mig_sub_4)
  #     # check = sum(mig_sub_1, mig_sub_2,mig_sub_3,mig_sub_4,mig_sub_5)
  #   ) |>
  #   tidyr::pivot_longer(mig_sub_1:mig_sub_5,
  #                names_to = "subregion",
  #                values_to = "mig_sub") |>
  #   dplyr::mutate(spatial_unit = as.character(stringr::str_extract(subregion, "(?<=mig_sub_).*"))) |>
  #   # divide the size of parameters with numbers by the number of regions (=5),
  #   # otherwise the multiplication of lines inflates the size of the population
  #   dplyr::mutate_at(dplyr::vars(imm_int_n, imm_nat_n, emi_nat_n, mig_nat_n), ~ ./5) |>
  #   dplyr::select(-subregion) |>
  # constructive::construct()

  parameters_short_5r <- tibble::tibble(
    nat = rep(c("ch", "int"), each = 1010L),
    sex = rep(rep(c("m", "f"), 2), each = 505L),
    age = rep(rep(seq(0, 100, by = 1), 4), each = 5L),
    start_n = rep(
      c(
        0, 2366, 2542, 2891, 2766, 2794, 2782, 2787, 2726, 2837, 2866, 2760, 2766,
        2799, 2823, 2707, 2768, 2660, 2744, 2760, 2767, 2730, 2686, 2639, 2872, 2812,
        2874, 2899, 3060, 2823, 2844, 3085, 3189, 3162, 3192, 3193, 3197, 3164, 3262,
        3130, 3280, 3263, 3300, 3269, 3288, 3131, 3091, 3087, 2931, 3008, 3194, 3242,
        3371, 3555, 3707, 3773, 4028, 4106, 4133, 4231, 4286, 4070, 4041, 3910, 3716,
        3609, 3443, 3416, 3277, 3219, 3054, 2977, 2865, 2641, 2672, 2552, 2582, 2485,
        2406, 2246, 2115, 2001, 1715, 1556, 1204, 1100, 1064, 915, 746, 688, 587, 446,
        389, 302, 234, 153, 118, 75, 35, 33, 38, 0, 2277, 2434, 2685, 2533, 2577,
        2609, 2671, 2660, 2642, 2599, 2580, 2653, 2600, 2763, 2581, 2683, 2549, 2564,
        2526, 2611, 2569, 2553, 2548, 2661, 2766, 2723, 2845, 2866, 2891, 2946, 2936,
        3186, 3172, 3268, 3149, 3267, 3238, 3240, 3184, 3288, 3272, 3375, 3408, 3272,
        3224, 3034, 3137, 3309, 3184, 3190, 3242, 3410, 3727, 3867, 3905, 4211, 4207,
        4307, 4287, 4399, 4297, 4143, 4054, 3949, 3751, 3732, 3716, 3524, 3425, 3272,
        3168, 3163, 2949, 2963, 2860, 2778, 2712, 2676, 2561, 2468, 2384, 2097, 1870,
        1638, 1556, 1432, 1275, 1259, 1059, 978, 806, 719, 560, 473, 378, 286, 203,
        148, 97, 149, 0, 920, 1120, 1157, 1137, 1159, 1189, 1143, 1228, 1121, 1162,
        1113, 1156, 1106, 1004, 1000, 1075, 954, 1076, 1064, 968, 919, 960, 986, 1162,
        1231, 1378, 1517, 1635, 1638, 1769, 1899, 1956, 2082, 2226, 2179, 2149, 2293,
        2244, 2248, 2321, 2216, 2254, 2236, 2176, 2087, 2051, 1928, 1878, 1784, 1726,
        1690, 1694, 1592, 1542, 1570, 1529, 1532, 1506, 1501, 1415, 1272, 1132, 1021,
        1008, 817, 753, 628, 592, 567, 495, 430, 403, 398, 441, 357, 369, 313, 310,
        242, 281, 264, 275, 208, 234, 202, 167, 119, 124, 95, 58, 41, 19, 18, 11, 16,
        7, 3, 0, 1, 0, 898, 974, 1100, 1145, 1094, 1075, 1049, 1128, 1064, 1089, 1023,
        1039, 933, 1023, 958, 920, 884, 808, 832, 798, 766, 780, 818, 948, 1028, 1162,
        1317, 1382, 1515, 1571, 1668, 1792, 1808, 1919, 1913, 1958, 1966, 1986, 2002,
        1972, 1966, 1986, 1912, 1873, 1714, 1776, 1634, 1542, 1568, 1485, 1392, 1481,
        1390, 1281, 1303, 1220, 1223, 1181, 1079, 1098, 981, 876, 824, 827, 696, 640,
        541, 510, 517, 500, 445, 403, 382, 374, 360, 374, 263, 292, 231, 241, 199,
        234, 207, 226, 204, 156, 152, 94, 93, 60, 34, 30, 21, 13, 10, 4, 3
      ),
      rep(rep(c(5L, 10L), 4), c(300L, 1L, 91L, 1L, 2L, 1L, 3L, 1L))
    ),
    year = rep(2024, 2020L),
    scen = rep("reference", 2020L),
    spatial_unit = rep(c("1", "2", "3", "4", "5"), 404),
    birthrate = rep(
      c(
        0, 0.000786, 0.001525, 0.003106, 0.005874, 0.010611, 0.01731, 0.026459,
        0.037882, 0.051065, 0.066655, 0.082599, 0.099543, 0.11384, 0.123888, 0.127307,
        0.121966, 0.108771, 0.090344, 0.070041, 0.050405, 0.034815, 0.022905,
        0.014548, 0.00941, 0.006123, 0.003948, 0.002777, 0.001967, 0.00127, 0.001205,
        0.000939, 0, 0.001146, 0.005, 0.010856, 0.018645, 0.029318, 0.040665,
        0.053519, 0.067371, 0.082407, 0.097902, 0.110989, 0.126001, 0.135507,
        0.141002, 0.141603, 0.136799, 0.127822, 0.115256, 0.100284, 0.084536,
        0.069715, 0.055096, 0.04232, 0.031369, 0.022854, 0.016109, 0.01098, 0.006943,
        0.004665, 0.002817, 0.001224, 0.000648, 0.000638, 0
      ),
      rep(c(600L, 5L, 845L, 5L, 255L), c(1L, 31L, 1L, 33L, 1L))
    ),
    int_mothers = rep(0.24983410749834106, 2020L),
    mor = rep(
      c(
        0.003628, 0.000415, 0.000389, 0.000343, 0, 0.000358, 0.000373, 0.000362,
        0.000367, 0.000372, 0.000379, 0.000349, 0.000357, 0.000349, 0.000346,
        0.000328, 0.000354, 0.00035, 0.000646, 0.000623, 0.000627, 0.000621, 0.00062,
        0.000626, 0.000608, 0.000633, 0.000605, 0.000609, 0.000903, 0.000911,
        0.000907, 0.000952, 0.001286, 0.001288, 0.001357, 0.001653, 0.00187, 0.00215,
        0.002068, 0.002523, 0.00269, 0.003172, 0.003469, 0.003891, 0.004107, 0.004486,
        0.005131, 0.005402, 0.005937, 0.006391, 0.006998, 0.007502, 0.00813, 0.008781,
        0.009461, 0.010567, 0.011466, 0.012435, 0.013969, 0.01553, 0.017222, 0.0196,
        0.022468, 0.025765, 0.029516, 0.034283, 0.039716, 0.0455, 0.053061, 0.061054,
        0.070598, 0.08, 0.092149, 0.103825, 0.116622, 0.129267, 0.141277, 0.152466,
        0.164313, 0.182119, 0.200855, 0.228013, 0.254237, 0.28, 0.314286, 0.333333,
        0.394737, 0.002957, 0.000433, 0.000407, 0.000369, 0, 0.000376, 0.000362,
        0.000368, 0.000352, 0.000349, 0.000346, 0.000339, 0.000312, 0.000313,
        0.000303, 0.000314, 0.000303, 0.000306, 0.000305, 0.000311, 0.000603,
        0.000606, 0.000588, 0.000583, 0.000607, 0.000617, 0.000655, 0.000952,
        0.000903, 0.001252, 0.001249, 0.00123, 0.001462, 0.001606, 0.001807, 0.002045,
        0.002135, 0.002376, 0.002553, 0.002798, 0.003181, 0.003489, 0.00386, 0.004192,
        0.004563, 0.005067, 0.005627, 0.00592, 0.006528, 0.0073, 0.007949, 0.00884,
        0.009802, 0.010855, 0.012154, 0.013641, 0.015482, 0.01733, 0.019806, 0.022647,
        0.025932, 0.029788, 0.034803, 0.040631, 0.046994, 0.055252, 0.064921,
        0.076078, 0.089718, 0.103774, 0.120531, 0.137546, 0.155556, 0.174844, 0.19641,
        0.216931, 0.240838, 0.265356, 0.283784, 0.309278, 0.362416, 0.003417, 0,
        0.000935, 0.001049, 0.00093, 0.000929, 0.001011, 0.001056, 0.001005, 0.000973,
        0.000827, 0.000779, 0.000699, 0.000636, 0.000592, 0.000589, 0.000548,
        0.000512, 0.000498, 0.00047, 0.000441, 0.000451, 0.000457, 0.00043, 0.00044,
        0.000428, 0.000896, 0.000883, 0.000892, 0.000917, 0.000956, 0.000974,
        0.001036, 0.001063, 0.00168, 0.001735, 0.001775, 0.001771, 0.001885, 0.001947,
        0.002555, 0.002627, 0.00263, 0.003351, 0.003362, 0.004287, 0.004752, 0.005352,
        0.005961, 0.007085, 0.0076, 0.00953, 0.009646, 0.011895, 0.012411, 0.014213,
        0.016355, 0.017456, 0.020202, 0.020525, 0.022504, 0.02449, 0.025641, 0.029126,
        0.029046, 0.0322, 0.034221, 0.036563, 0.043269, 0.047009, 0.054455, 0.066066,
        0.075949, 0.089069, 0.116402, 0.137931, 0.195122, 0.210526, 0.277778,
        0.272727, 0.3125, 0.285714, 0.333333, 0, 1, 0.002676, 0, 0.000822, 0.00073,
        0.000696, 0.000639, 0.000618, 0.000585, 0.000547, 0.000544, 0.000514,
        0.000517, 0.000506, 0.000505, 0.000501, 0.000498, 0.000506, 0.000508,
        0.000503, 0.000523, 0.000534, 0.000583, 0.000563, 0.000612, 0.000647,
        0.001276, 0.001345, 0.001434, 0.00135, 0.001437, 0.001559, 0.002304, 0.002463,
        0.002465, 0.002559, 0.002808, 0.002766, 0.003094, 0.003464, 0.003686,
        0.004914, 0.004342, 0.004717, 0.005566, 0.005894, 0.007759, 0.008032,
        0.009019, 0.00995, 0.010471, 0.01071, 0.013908, 0.013387, 0.015209, 0.017153,
        0.021692, 0.024948, 0.025126, 0.029979, 0.033816, 0.044346, 0.0489, 0.057692,
        0.072607, 0.085106, 0.096774, 0.116667, 0.133333, 0.147059, 0.169492,
        0.190476, 0.230769, 0.3, 0.25, 0.333333
      ),
      rep(
        c(5L, 60L, 5L, 15L, 5L, 10L, 5L, 100L, 5L, 10L, 5L, 75L, 5L, 10L, 5L, 10L, 5L, 125L, 5L, 10L, 5L, 10L),
        c(4L, 1L, 2L, 1L, 13L, 1L, 69L, 1L, 6L, 1L, 70L, 1L, 22L, 1L, 58L, 1L, 2L, 1L, 68L, 1L, 3L, 1L)
      )
    ),
    emi_int = rep(
      c(
        0.001218, 0.004649, 0.004327, 0.004151, 0.003977, 0.003579, 0.003595,
        0.003229, 0.002935, 0.00282, 0.002442, 0.002174, 0.001808, 0.001786, 0.001417,
        0.001478, 0.001445, 0.00188, 0.002551, 0.003261, 0.003975, 0.004396, 0.00484,
        0.005305, 0.005919, 0.006046, 0.005915, 0.005864, 0.005882, 0.005313,
        0.005274, 0.004862, 0.004704, 0.004428, 0.004386, 0.004385, 0.004066,
        0.003793, 0.003679, 0.003514, 0.003354, 0.003371, 0.00303, 0.003059, 0.003041,
        0.002874, 0.002912, 0.002592, 0.002729, 0.00266, 0.002818, 0.002776, 0.002966,
        0.003094, 0.003237, 0.003446, 0.003972, 0.00414, 0.004355, 0.004727, 0.0049,
        0.004668, 0.004454, 0.003836, 0.003767, 0.005819, 0.004647, 0.003513,
        0.003357, 0.003107, 0.00262, 0.002351, 0.002094, 0.001893, 0.001497, 0.001567,
        0.001162, 0.001207, 0.000831, 0.00089, 0.000946, 0.001, 0.000583, 0.000643,
        0.000831, 0.000909, 0.00094, 0.001093, 0.00134, 0, 0.002559, 0.004831,
        0.00493, 0.004469, 0.004343, 0.004269, 0.00345, 0.00337, 0.003008, 0.00265,
        0.002309, 0.002326, 0.001885, 0.001538, 0.001448, 0.00155, 0.001491, 0.001962,
        0.00234, 0.002771, 0.003447, 0.004282, 0.0047, 0.005102, 0.005637, 0.005423,
        0.005509, 0.005624, 0.005234, 0.005189, 0.004752, 0.004768, 0.004394,
        0.004098, 0.003978, 0.003811, 0.003673, 0.003397, 0.003086, 0.002827,
        0.002737, 0.002751, 0.002667, 0.002641, 0.002445, 0.002481, 0.002637, 0.00255,
        0.00272, 0.002827, 0.002821, 0.003085, 0.003519, 0.003488, 0.00362, 0.003585,
        0.003562, 0.003565, 0.003483, 0.003266, 0.003183, 0.003025, 0.003138, 0.00296,
        0.003292, 0.002399, 0.002144, 0.001615, 0.001135, 0.000876, 0.000917,
        0.000631, 0.000632, 0.000678, 0.000675, 0.000699, 0.00072, 0.000369, 0.000374,
        0.00039, 0.000405, 0.000419, 0.000477, 0.000535, 0.000611, 0.000643, 0.000698,
        0.000784, 0.000794, 0, 0.007772, 0.036957, 0.03125, 0.026793, 0.021988,
        0.019845, 0.017662, 0.014873, 0.013029, 0.010705, 0.010327, 0.008985,
        0.008651, 0.007233, 0.006972, 0.006, 0.006512, 0.006289, 0.010223, 0.014098,
        0.018595, 0.025027, 0.029167, 0.034483, 0.037005, 0.03818, 0.039187, 0.036915,
        0.037309, 0.03602, 0.035048, 0.033702, 0.03272, 0.0317, 0.030548, 0.02983,
        0.029316, 0.027911, 0.027629, 0.02669, 0.026282, 0.025271, 0.024845, 0.02415,
        0.024357, 0.023, 0.022428, 0.021784, 0.021299, 0.02074, 0.019699, 0.020118,
        0.019481, 0.019472, 0.020104, 0.021019, 0.022237, 0.024804, 0.02656, 0.025316,
        0.028269, 0.021226, 0.025618, 0.033301, 0.043651, 0.073439, 0.054449,
        0.023885, 0.015203, 0.014109, 0.012121, 0.011628, 0.012407, 0.012563,
        0.011338, 0.011204, 0.01084, 0.009585, 0.009677, 0.008264, 0.007117, 0.003788,
        0.007273, 0.004808, 0.004274, 0.00495, 0.005988, 0.008403, 0.008065, 0.010526,
        0, 0.003626, 0.028953, 0.026694, 0.025455, 0.023581, 0.021024, 0.018605,
        0.017159, 0.014184, 0.013158, 0.011938, 0.01173, 0.01155, 0.010718, 0.010753,
        0.011482, 0.01087, 0.011312, 0.013614, 0.014423, 0.015038, 0.018277, 0.019231,
        0.022005, 0.024262, 0.026265, 0.026678, 0.025816, 0.025326, 0.026403,
        0.026098, 0.025779, 0.024554, 0.023783, 0.022408, 0.021432, 0.019918, 0.01882,
        0.01712, 0.016484, 0.015213, 0.014751, 0.013595, 0.013075, 0.01228, 0.012252,
        0.011824, 0.011628, 0.011025, 0.010842, 0.010774, 0.010057, 0.010128,
        0.010072, 0.010929, 0.013047, 0.015574, 0.018806, 0.022862, 0.026877,
        0.030965, 0.029562, 0.02968, 0.03034, 0.038694, 0.022989, 0.021875, 0.016636,
        0.013725, 0.01354, 0.012, 0.011236, 0.012407, 0.010471, 0.010695, 0.011111,
        0.010695, 0.011407, 0.013699, 0.012987, 0.012448, 0.01005, 0.012821, 0.009662,
        0.013274, 0.009804, 0.012821, 0.013158, 0.010638, 0.010753, 0.016667,
        0.029412, 0.033333, 0
      ),
      rep(
        c(5L, 60L, 5L, 60L, 5L, 55L, 5L, 10L, 5L, 35L),
        c(89L, 1L, 89L, 1L, 90L, 1L, 90L, 1L, 2L, 1L)
      )
    ),
    emi_nat = rep(
      c(
        0.008526, 0.02071, 0.02203, 0.018679, 0.015907, 0.013601, 0.011862, 0.010405,
        0.008804, 0.007755, 0.006978, 0.006159, 0.005423, 0.004645, 0.004251,
        0.004064, 0.003974, 0.005263, 0.008382, 0.013043, 0.01807, 0.024176, 0.030901,
        0.038272, 0.045613, 0.05192, 0.056019, 0.057951, 0.057516, 0.054906, 0.051336,
        0.047002, 0.042333, 0.037951, 0.033835, 0.030379, 0.027213, 0.024652,
        0.022379, 0.020447, 0.018902, 0.017775, 0.016364, 0.015601, 0.014599,
        0.014053, 0.013264, 0.012634, 0.012282, 0.011636, 0.011271, 0.010796,
        0.010383, 0.010127, 0.009711, 0.009276, 0.008937, 0.008768, 0.008468,
        0.008036, 0.007933, 0.007617, 0.007424, 0.007161, 0.00915, 0.012746, 0.00639,
        0.00644, 0.006103, 0.005902, 0.005894, 0.00571, 0.005585, 0.005301, 0.00524,
        0.005094, 0.005035, 0.004829, 0.004572, 0.004452, 0.004255, 0.004498,
        0.004082, 0.003856, 0.004153, 0.003636, 0.003759, 0.003279, 0.004021,
        0.002907, 0.003407, 0.004484, 0.002571, 0.003311, 0.004274, 0, 0.009382,
        0.028107, 0.023007, 0.018994, 0.015792, 0.013194, 0.011115, 0.00936, 0.008271,
        0.007192, 0.006541, 0.005814, 0.005654, 0.005385, 0.005429, 0.005424,
        0.006336, 0.008239, 0.01209, 0.018606, 0.027959, 0.038926, 0.05092, 0.061617,
        0.069899, 0.074837, 0.076019, 0.074165, 0.069784, 0.063646, 0.057026,
        0.049728, 0.043315, 0.037201, 0.031824, 0.027628, 0.023875, 0.021001,
        0.018519, 0.016646, 0.015511, 0.014364, 0.013333, 0.012617, 0.012225,
        0.011787, 0.011536, 0.011157, 0.010879, 0.010678, 0.010345, 0.010179,
        0.009971, 0.009928, 0.009827, 0.009475, 0.009261, 0.009033, 0.008823,
        0.008631, 0.008411, 0.008378, 0.007965, 0.007893, 0.009876, 0.009064,
        0.007235, 0.006997, 0.00681, 0.006423, 0.006418, 0.005997, 0.005691, 0.005765,
        0.0054, 0.005245, 0.00504, 0.004794, 0.004484, 0.004295, 0.004052, 0.004195,
        0.003815, 0.003743, 0.003663, 0.003213, 0.002793, 0.003137, 0.002383,
        0.002833, 0.002045, 0.002481, 0.001391, 0.001786, 0.002114, 0.002646, 0,
        0.005181, 0.023913, 0.021429, 0.019879, 0.01759, 0.015531, 0.014298, 0.012248,
        0.011401, 0.009813, 0.008606, 0.008086, 0.00692, 0.006329, 0.00498, 0.005,
        0.004651, 0.006289, 0.010223, 0.016917, 0.025826, 0.03482, 0.044792, 0.052738,
        0.05852, 0.062551, 0.064586, 0.06526, 0.06422, 0.062271, 0.059921, 0.056872,
        0.054192, 0.050913, 0.048068, 0.044975, 0.042345, 0.039686, 0.037879,
        0.035587, 0.034037, 0.032942, 0.0315, 0.030859, 0.029871, 0.029229, 0.028279,
        0.02749, 0.027157, 0.026345, 0.025492, 0.024852, 0.023613, 0.022613, 0.021401,
        0.020382, 0.019621, 0.018277, 0.017264, 0.015989, 0.014841, 0.013365,
        0.012367, 0.011753, 0.010913, 0.011016, 0.010624, 0.009554, 0.008446,
        0.007055, 0.006061, 0.006977, 0.004963, 0.005025, 0.004535, 0.002801, 0.00271,
        0.003195, 0.003226, 0.004132, 0.003559, 0.003788, 0.003636, 0, 0.003626,
        0.024499, 0.021561, 0.019091, 0.017467, 0.015539, 0.013953, 0.012393,
        0.011525, 0.010338, 0.009183, 0.00782, 0.0077, 0.006431, 0.005865, 0.005219,
        0.005435, 0.007919, 0.013614, 0.02524, 0.038847, 0.050914, 0.060256, 0.066015,
        0.068565, 0.067121, 0.065404, 0.061503, 0.057164, 0.052805, 0.048377,
        0.044365, 0.040737, 0.037058, 0.033872, 0.030842, 0.028601, 0.025941,
        0.024169, 0.022478, 0.021298, 0.019837, 0.019134, 0.018305, 0.018153,
        0.017503, 0.017455, 0.017136, 0.016861, 0.017219, 0.016835, 0.016523, 0.01688,
        0.016547, 0.015613, 0.015349, 0.014754, 0.014718, 0.013548, 0.012975, 0.01184,
        0.011213, 0.010274, 0.008495, 0.007255, 0.005747, 0.004688, 0.003697,
        0.003922, 0.003868, 0.004, 0.004494, 0.002481, 0.002618, 0.002674, 0.002778,
        0.002674, 0.003802, 0.003425, 0.004329, 0.004149, 0.005025, 0.004274,
        0.004831, 0.004425, 0
      ),
      rep(c(5L, 30L, 5L, 25L, 5L, 90L, 5L, 80L), c(95L, 1L, 96L, 1L, 83L, 1L, 85L, 1L))
    ),
    acq = rep(
      c(
        0, 0.011957, 0.014286, 0.014693, 0.014952, 0.015531, 0.016821, 0.016623,
        0.019544, 0.022302, 0.024957, 0.028751, 0.033737, 0.037975, 0.041833, 0.045,
        0.046512, 0.045073, 0.040892, 0.020677, 0.017562, 0.016322, 0.014583,
        0.013185, 0.011188, 0.009748, 0.008708, 0.00791, 0.007339, 0.007326, 0.006783,
        0.007372, 0.007669, 0.008165, 0.008985, 0.010096, 0.010703, 0.011339,
        0.012032, 0.013345, 0.013356, 0.013538, 0.014197, 0.014311, 0.014706,
        0.014375, 0.014139, 0.014523, 0.013312, 0.013453, 0.012746, 0.012426,
        0.011806, 0.011307, 0.011025, 0.010191, 0.00981, 0.009138, 0.009296, 0.008661,
        0.007774, 0.007075, 0.007067, 0.006856, 0.005952, 0.00612, 0.005312, 0.004777,
        0.005068, 0.003527, 0.00404, 0.004651, 0.002481, 0.002513, 0.002268, 0.002801,
        0.00271, 0.003195, 0.003226, 0.004132, 0.003559, 0.003788, 0.003636, 0,
        0.020045, 0.019507, 0.017273, 0.015721, 0.015539, 0.015814, 0.017159,
        0.018617, 0.021617, 0.024793, 0.029326, 0.033686, 0.038585, 0.044966,
        0.049061, 0.051087, 0.050905, 0.045792, 0.038462, 0.033835, 0.028721,
        0.024359, 0.020782, 0.017932, 0.015564, 0.012048, 0.01063, 0.008683, 0.008581,
        0.008912, 0.009592, 0.010603, 0.012721, 0.013549, 0.015159, 0.015322,
        0.016277, 0.01712, 0.017483, 0.018256, 0.018311, 0.018127, 0.017782, 0.017619,
        0.017503, 0.016892, 0.016524, 0.015564, 0.015306, 0.014141, 0.013649,
        0.012829, 0.01223, 0.01171, 0.010744, 0.009016, 0.008177, 0.007621, 0.007414,
        0.006375, 0.006116, 0.005708, 0.004854, 0.003628, 0.00431, 0.003125, 0.003697,
        0.001961, 0.001934, 0.002, 0.002247, 0.002481, 0
      ),
      rep(c(1015L, 5L, 95L, 5L, 140L), c(1L, 82L, 1L, 72L, 1L))
    ),
    imm_int_n = rep(
      c(
        0.8, 9.6, 3.4, 3, 2.8, 2.6, 2.4, 2.2, 2, 1.8, 1.6, 1.4, 1.2, 1, 1.2, 1.6, 1.8,
        2.2, 2.4, 2.6, 2.8, 2.6, 2.4, 2.2, 2, 1.8, 1.6, 1.8, 2, 2.2, 2.4, 2.2, 2, 1.8,
        1.6, 1.4, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0, 0.8, 8.8, 2.8, 2.6, 2.4, 2.2, 2, 1.8,
        1.6, 1.4, 1.2, 1.4, 1.2, 1.4, 1.6, 1.8, 2, 2.2, 2.4, 2.6, 2.8, 2.6, 2.4, 2.2,
        2, 1.8, 1.6, 1.4, 1.2, 1.4, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0, 2.8, 22.6, 10.6,
        10, 9.8, 9.4, 9.2, 9, 8.8, 8.6, 8.4, 8, 7.6, 8, 9.4, 11.6, 14.4, 17.8, 21.4,
        24.6, 27.6, 29.8, 31.4, 32.4, 32.8, 32.6, 32.4, 31.6, 30.6, 29.4, 28, 26.8,
        25.4, 24, 22.8, 21.4, 20.2, 19, 18, 17, 16, 15, 14.2, 13.4, 12.8, 12, 11.4,
        10.6, 10, 9.2, 8.6, 7.6, 6.8, 5.8, 5, 4.4, 3.8, 3.2, 2.6, 2.2, 1.8, 1.6, 1.4,
        1.2, 1, 0.8, 0.6, 0.4, 0.2, 0, 3.2, 24.4, 10.6, 10, 9.6, 9.2, 9, 8.8, 8.4,
        8.2, 8, 7.6, 7.4, 7, 6.6, 6.2, 6, 7.4, 10.2, 14.2, 18.6, 22.4, 25, 26.8, 27.6,
        27, 26, 24.8, 23.6, 22.2, 21, 19.6, 18.4, 17.2, 16.2, 15.2, 14.2, 13.2, 12.6,
        11.8, 11, 10.4, 9.8, 9.4, 8.8, 8.4, 8, 7.6, 7.2, 6.8, 6.4, 5.8, 5.4, 4.6, 4.2,
        3.6, 3, 2.6, 2.4, 2, 1.6, 1.4, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0
      ),
      rep(
        c(
          5L, 15L, 5L, 10L, 15L, 5L, 20L, 40L, 15L, 10L, 20L, 10L, 5L, 10L, 15L, 5L,
          15L, 5L, 15L, 20L, 30L, 50L, 5L, 10L, 5L, 10L, 5L, 25L, 5L, 10L, 5L, 10L, 5L,
          25L, 10L, 15L, 10L, 5L, 10L, 15L, 25L, 40L, 30L, 20L, 25L, 35L, 45L, 30L, 5L,
          10L, 5L, 15L, 5L, 10L, 5L, 10L, 30L, 105L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L,
          20L, 60L, 35L, 40L
        ),
        c(
          4L, 1L, 7L, 1L, 1L, 6L, 1L, 1L, 1L, 3L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 4L,
          2L, 1L, 1L, 3L, 1L, 4L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 3L, 1L, 2L, 1L, 1L, 2L,
          1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 6L, 1L, 1L, 1L, 3L, 1L, 53L, 2L, 1L,
          1L, 10L, 1L, 5L, 1L, 7L, 1L, 38L, 2L, 1L, 1L, 1L, 1L
        )
      )
    ),
    imm_nat_n = rep(
      c(
        9.4, 17.6, 15.8, 12.4, 9.8, 8.2, 7, 6, 5.2, 4.6, 4.2, 3.8, 3.4, 3.2, 3.4, 3.8,
        5, 6.8, 9.8, 13.8, 17.8, 22, 23.8, 26, 28.2, 30.2, 30.6, 31.6, 31.8, 32, 31.2,
        29.4, 27, 24.6, 22, 20.2, 18.2, 16.8, 15, 13.8, 12.8, 11.8, 11, 10, 9.4, 8.8,
        8.6, 8.8, 8.4, 8.6, 8.2, 8, 8.2, 8, 8.2, 7.6, 7.4, 6.8, 6.2, 6.6, 7, 5.8, 5,
        4.2, 3.6, 3, 2.8, 2.6, 2.2, 2, 1.8, 1.6, 1.4, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0,
        11.4, 16.2, 15.8, 15, 11.4, 9.4, 7.6, 6.4, 5.4, 4.6, 4, 3.4, 3.2, 2.8, 2.6,
        2.4, 2.8, 4, 6.4, 10.2, 14.6, 18.8, 23, 27.4, 33.6, 36.4, 37.8, 38, 35.8,
        34.2, 32.6, 31.4, 29, 27, 24.4, 22.4, 19.8, 18.4, 16.6, 15, 13.4, 12.4, 11,
        10.2, 9, 8.2, 7.8, 7.6, 7.4, 7.6, 7.8, 8.2, 8.6, 8.8, 8.4, 8.6, 8.2, 7.8, 7.4,
        7, 6.6, 5.6, 5, 4.2, 3.6, 3.4, 3, 2.8, 2.6, 2.4, 2.2, 2, 1.8, 1.6, 1.4, 1.2,
        1, 0.8, 0.6, 0.4, 0.2, 0, 4, 5.6, 5.8, 5, 4.6, 4.4, 4.2, 3.8, 3.6, 3.4, 3,
        2.6, 2.4, 2.8, 3.6, 4.6, 6.2, 7.4, 9.6, 12, 15.8, 18.2, 20.6, 23.2, 24.4,
        25.4, 26.4, 27.2, 27.4, 27, 26.4, 26, 24.2, 23.2, 22.2, 20.6, 19.2, 18.2,
        16.8, 16.2, 14.6, 13.6, 12.4, 11.6, 10.4, 9.8, 8.8, 8.4, 7.6, 7.2, 6.8, 6.4,
        5.8, 5.4, 5, 4.4, 3.6, 3.2, 2.6, 2.4, 2.2, 1.8, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0,
        3.8, 6.6, 6.2, 5.4, 4.6, 4.2, 3.6, 3.2, 2.8, 2.4, 2.2, 1.8, 1.6, 1.4, 1.2,
        1.4, 1.8, 2.6, 4.4, 6.4, 8.2, 10.2, 12, 14.6, 16.4, 18.2, 19.4, 20.2, 20.6,
        20, 19.6, 19.4, 18, 17.2, 16.2, 15, 13.4, 12.4, 11.2, 10.4, 9.6, 8.8, 8.2,
        7.6, 7, 6.8, 6.4, 6, 5.6, 5.4, 5.2, 5, 4.6, 4.4, 4.2, 3.6, 3.4, 3, 2.8, 2.2,
        2, 1.6, 1.4, 1.2, 0.8, 0.6, 0.4, 0.2, 0
      ),
      rep(
        c(
          5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 15L, 20L, 15L,
          25L, 5L, 10L, 5L, 10L, 15L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 15L, 10L, 5L,
          25L, 15L, 5L, 10L, 5L, 20L, 5L, 10L, 5L, 10L, 35L, 75L, 5L, 10L, 5L, 10L, 5L,
          10L, 5L, 10L, 5L, 45L, 40L, 70L
        ),
        c(
          1L, 1L, 10L, 2L, 37L, 1L, 4L, 1L, 11L, 2L, 1L, 1L, 2L, 2L, 1L, 1L, 1L, 1L,
          27L, 1L, 24L, 2L, 1L, 13L, 2L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 2L,
          1L, 9L, 1L, 16L, 1L, 35L, 1L, 2L, 1L, 1L, 1L, 49L, 1L, 9L, 1L, 2L, 1L, 1L, 1L,
          1L, 1L
        )
      )
    ),
    emi_nat_n = rep(
      c(
        4.2, 9.8, 11.2, 10.8, 8.8, 7.6, 6.6, 5.8, 4.8, 4.4, 4, 3.4, 3, 2.6, 2.4, 2.2,
        2.8, 4.6, 7.2, 10, 13.2, 16.6, 20.2, 26.2, 29.2, 32.2, 33.6, 35.2, 31, 29.2,
        29, 27, 24, 21.6, 19.4, 17.4, 15.6, 14.6, 12.8, 12.4, 11.6, 10.8, 10.2, 9.6,
        8.8, 8.2, 7.8, 7.2, 7, 7.2, 7, 7.2, 7, 7.2, 7, 6.8, 6.2, 6, 5.6, 6.8, 9.2,
        4.4, 4, 3.8, 3.6, 3.4, 3.2, 2.8, 2.6, 2.4, 2.2, 2, 1.8, 1.4, 1.2, 1, 0.8, 0.6,
        0.4, 0.2, 0, 4.4, 12.8, 11.2, 10.2, 8, 6.8, 5.8, 5, 4.4, 3.8, 3.4, 3, 2.8, 3,
        2.8, 3.4, 4.2, 6.2, 9.4, 14.6, 20, 26, 31.4, 37.2, 41.4, 42.2, 40, 36.8, 33.6,
        29.2, 27.6, 23.6, 20.8, 17.4, 15.6, 13.6, 12, 10.6, 10.2, 9.4, 9, 8.6, 8, 7.6,
        7, 7.2, 6.8, 6.6, 6.8, 7.4, 7.6, 7.4, 7.8, 7.6, 7.4, 7.2, 6.6, 6.4, 7.8, 6.8,
        5.4, 5.2, 4.8, 4.4, 4.2, 3.8, 3.6, 3.4, 3.2, 3, 2.8, 2.6, 2.4, 2.2, 2, 1.6,
        1.4, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0, 1.2, 4.4, 4.8, 4.6, 4, 3.6, 3.4, 2.8, 2.2,
        2, 1.8, 1.6, 1.4, 1, 1.2, 2.2, 3.6, 5, 6.4, 8.6, 10.4, 13.6, 15.4, 17.8, 19.8,
        21, 20.4, 21.2, 21.6, 21.2, 21.4, 19.6, 18.2, 17, 16, 15.8, 14.6, 14.2, 13.8,
        13, 12.2, 11.6, 10.6, 10.2, 9.4, 8.8, 8.4, 8, 7.2, 6.6, 6.4, 6, 5.6, 5.2, 4.8,
        4.2, 3.4, 2.8, 2.4, 2.2, 1.8, 1.6, 1.2, 1, 0.8, 0.6, 0.4, 0.2, 0, 0.8, 4.4,
        4.2, 4, 3.4, 3, 2.6, 2.2, 2, 1.6, 1.2, 1, 1.4, 2.2, 4.2, 6.2, 7.8, 9.4, 10.8,
        13, 13.8, 15.2, 16.2, 15.8, 16, 15.2, 14.8, 14.6, 13.4, 13, 11.8, 11.2, 10.2,
        9.6, 9, 8.4, 7.8, 7.6, 7, 6.8, 6, 6.2, 5.6, 5.2, 5.4, 5, 4.6, 5, 4.6, 4, 3.6,
        3.2, 2.8, 2.6, 2.2, 1.8, 1.4, 1.2, 0.8, 0.6, 0.4, 0.2, 0
      ),
      rep(
        c(
          5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 15L,
          30L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 5L, 10L, 20L, 25L,
          5L, 10L, 5L, 15L, 5L, 10L, 5L, 10L, 5L, 10L, 15L, 40L, 90L, 5L, 10L, 5L, 10L,
          5L, 10L, 5L, 10L, 5L, 25L, 65L, 80L
        ),
        c(
          15L, 1L, 34L, 2L, 1L, 1L, 1L, 1L, 5L, 1L, 5L, 2L, 3L, 1L, 3L, 2L, 2L, 1L, 11L,
          1L, 12L, 1L, 19L, 1L, 2L, 1L, 5L, 2L, 19L, 1L, 4L, 3L, 1L, 1L, 7L, 1L, 5L, 1L,
          15L, 1L, 2L, 1L, 32L, 1L, 1L, 1L, 1L, 2L, 1L, 3L, 1L, 2L, 3L, 37L, 2L, 9L, 1L,
          1L, 1L
        )
      )
    ),
    mig_nat_n = rep(
      c(
        5.2, 7.8, 6.4, 5, 3.6, 2.2, 1.6, 1.2, 0.8, 0.6, 0.8, 1, 0.6, -0.8, -2.2, -3.2,
        -3.4, -2.8, -2.4, -4.2, -5.4, -6.2, -5.4, -5, -0.4, 2.4, 2.8, 5, 7.2, 7.8,
        7.6, 7.2, 6.4, 5.6, 5.4, 4.4, 3.4, 3, 2.6, 2.2, 1.8, 1.6, 1.4, 1.6, 1, 0.8, 1,
        0.8, 1.2, 0.8, 0.6, 1.2, 0.8, 0.6, -0.2, -2.2, 1.4, 0.6, 0.2, -0.2, -0.6,
        -0.4, -0.6, -0.4, -0.2, 0, -0.2, 0, 0.2, 0, 0.2, 0, 7, 3.4, 4.6, 4.8, 3.4,
        2.6, 1.8, 1.4, 1, 0.8, 0.6, 0.4, 0.2, 0, -0.4, -0.6, -0.2, 0.2, 0.8, 0, -1.2,
        -3, -4, -3.6, -5, -3.6, -4.2, -2, -1, 0.6, 3.4, 3.8, 5.4, 6.2, 7, 6.8, 6.2,
        6.4, 6, 4.8, 4, 3.4, 2.4, 2.2, 1.4, 1.2, 0.8, 0.4, 0.6, 1, 1.2, 1.4, 1.2, 1,
        1.4, 1, 0.8, 1, 1.2, 1, 1.2, 1, -0.8, -0.2, 0.2, -0.2, -0.6, -0.8, -0.6, -0.4,
        -0.2, -0.4, 0, 0.2, 0, 0.2, 0, 0.2, 0, 2.8, 1.2, 1, 1.2, 1, 1.4, 1, 1.4, 1.2,
        1, 1.4, 1.6, 1.4, 1, 1.2, 1, 1.6, 2.2, 2.8, 3.4, 5, 5.2, 5.6, 6.2, 5.8, 5.6,
        6.8, 7.8, 6, 6.2, 4.8, 4.6, 4, 3, 3.2, 2.4, 2, 1.8, 1.4, 1, 0.4, 0.6, 0.4,
        0.2, 0.4, 0.2, 0.4, 0.2, 0, 0.2, 0, 0.2, 0, 3, 2.2, 2.4, 2, 1.4, 1.2, 1, 0.6,
        0.4, 0.6, 0.2, 0.4, 0.2, 0.4, 0.2, 0.4, 0.8, 1.2, 1.6, 2.6, 3, 3.2, 4.4, 4.6,
        4.8, 4.6, 4.2, 4.4, 3.8, 3.2, 2.8, 2.2, 2, 1.8, 1.2, 0.8, 1, 0.6, 0.8, 0.2,
        0.4, 0.6, 0, 0.4, 0.6, 0.4, 0.6, 0, 0.2, 0, 0.2, 0.4, 0.6, 0.4, 0.2, 0, 0.2,
        0, 0.2, 0
      ),
      rep(
        c(
          5L, 10L, 5L, 15L, 5L, 10L, 5L, 20L, 5L, 10L, 5L, 45L, 10L, 5L, 10L, 5L, 25L,
          5L, 10L, 5L, 25L, 5L, 10L, 5L, 10L, 5L, 25L, 10L, 15L, 10L, 5L, 20L, 5L, 25L,
          15L, 10L, 15L, 5L, 15L, 5L, 10L, 5L, 10L, 15L, 5L, 10L, 5L, 10L, 5L, 10L, 5L,
          10L, 15L, 5L, 10L, 25L, 5L, 10L, 5L, 40L, 20L, 15L, 75L, 5L, 10L, 5L, 10L, 5L,
          10L, 15L, 10L, 5L, 15L, 5L, 10L, 5L, 10L, 5L, 15L, 5L, 10L, 5L, 10L, 5L, 10L,
          35L, 30L, 10L, 70L
        ),
        c(
          7L, 1L, 2L, 2L, 27L, 1L, 1L, 1L, 4L, 1L, 13L, 1L, 1L, 2L, 1L, 2L, 1L, 1L, 1L,
          1L, 1L, 14L, 1L, 41L, 1L, 10L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 4L,
          1L, 2L, 1L, 1L, 1L, 1L, 4L, 1L, 2L, 2L, 9L, 1L, 9L, 1L, 1L, 1L, 1L, 1L, 1L,
          1L, 2L, 1L, 2L, 1L, 1L, 5L, 1L, 1L, 1L, 4L, 1L, 1L, 1L, 9L, 1L, 9L, 1L, 3L,
          1L, 9L, 1L, 1L, 1L, 1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L
        )
      )
    ),
    fso_projection_n = rep(
      c(
        2481, 2452, 2595, 2935, 2804, 2827, 2814, 2816, 2760, 2869, 2901, 2799, 2812,
        2847, 2872, 2759, 2823, 2705, 2781, 2767, 2764, 2724, 2683, 2637, 2859, 2793,
        2851, 2880, 3042, 2830, 2865, 3109, 3225, 3212, 3248, 3250, 3254, 3220, 3315,
        3186, 3331, 3308, 3344, 3311, 3327, 3169, 3124, 3119, 2960, 3035, 3218, 3263,
        3392, 3569, 3717, 3781, 4030, 4102, 4129, 4220, 4267, 4053, 4020, 3889, 3689,
        3562, 3417, 3387, 3245, 3182, 3016, 2937, 2822, 2598, 2624, 2500, 2523, 2419,
        2334, 2169, 2031, 1908, 1624, 1461, 1119, 1012, 965, 820, 659, 600, 505, 378,
        326, 247, 187, 119, 88, 54, 24, 22, 23, 2371, 2344, 2477, 2728, 2570, 2608,
        2637, 2697, 2687, 2670, 2631, 2613, 2690, 2638, 2809, 2628, 2729, 2595, 2602,
        2561, 2636, 2582, 2554, 2541, 2654, 2752, 2715, 2834, 2865, 2896, 2961, 2967,
        3223, 3222, 3324, 3213, 3330, 3301, 3307, 3250, 3348, 3327, 3426, 3451, 3314,
        3258, 3067, 3164, 3329, 3204, 3209, 3260, 3426, 3738, 3873, 3911, 4209, 4202,
        4300, 4280, 4390, 4286, 4131, 4040, 3922, 3730, 3711, 3694, 3500, 3399, 3244,
        3139, 3131, 2915, 2925, 2819, 2734, 2665, 2623, 2503, 2404, 2312, 2025, 1795,
        1562, 1471, 1340, 1178, 1147, 951, 862, 697, 609, 463, 381, 296, 218, 150,
        106, 67, 95, 1173, 994, 1127, 1165, 1149, 1170, 1199, 1160, 1238, 1135, 1172,
        1121, 1155, 1103, 1002, 994, 1062, 952, 1074, 1089, 1010, 974, 1029, 1069,
        1254, 1334, 1482, 1627, 1742, 1754, 1882, 2006, 2060, 2174, 2305, 2259, 2228,
        2352, 2299, 2295, 2353, 2246, 2274, 2248, 2185, 2094, 2055, 1932, 1882, 1785,
        1729, 1687, 1690, 1588, 1537, 1557, 1512, 1506, 1473, 1468, 1378, 1247, 1104,
        986, 961, 756, 709, 610, 578, 554, 483, 419, 392, 386, 427, 346, 357, 303,
        299, 233, 269, 253, 262, 199, 223, 191, 155, 109, 112, 83, 50, 33, 15, 13, 8,
        11, 5, 2, 0, 1127, 987, 994, 1113, 1155, 1106, 1089, 1062, 1136, 1071, 1091,
        1024, 1031, 926, 1002, 934, 896, 861, 792, 826, 811, 803, 843, 901, 1041,
        1132, 1269, 1422, 1491, 1614, 1663, 1750, 1863, 1869, 1968, 1956, 1993, 2007,
        2015, 1981, 1972, 1987, 1913, 1872, 1716, 1774, 1635, 1546, 1566, 1486, 1396,
        1479, 1391, 1282, 1298, 1213, 1208, 1161, 1055, 1068, 955, 853, 801, 797, 683,
        629, 534, 505, 510, 492, 438, 397, 378, 369, 354, 368, 259, 286, 225, 234,
        194, 226, 200, 215, 195, 147, 140, 86, 84, 53, 52, 29, 24, 17, 10, 7, 3, 2
      ),
      rep(c(5L, 15L, 5L, 10L, 5L, 10L, 5L, 10L), c(300L, 1L, 36L, 1L, 56L, 1L, 3L, 1L))
    ),
    mig_sub = rep(c(-0.1253, -0.1794, -0.1924, 0.0434, 0.4537), 404),
  )


  ## FSO population with fictitious subregions ----
  # fso_population |>
  #   dplyr::rename(n_tot = n) |>
  #   # duplicating rows 5 times
  #   tidyr::uncount(5) |>
  #   # create 5 subregions
  #   dplyr::mutate(spatial_unit = rep(1:5, times = nrow(fso_population))) |>
  #   dplyr::mutate(
  #     # Create fictitious n
  #     n = dplyr::case_match(
  #       spatial_unit,
  #       1 ~ round(n_tot * 0.3),
  #       2 ~ round(n_tot * 0.25),
  #       3 ~ round(n_tot * 0.2),
  #       4 ~ round(n_tot * 0.15),
  #       # 5 ~ round(n_tot * 0.1),
  #       .default = NA
  #     ),
  #     .keep = "all"
  #   ) |>
  #   # create region 5 by subtracting sum of 1:4 from original n to get exact same n
  #   # (avoid rounding errors)
  #   ## get sum of regions 1-4
  #   dplyr::mutate(sum = sum(n, na.rm = TRUE), .by=c(year,nat,sex,age)) |>
  #   ## compute region 5
  #   dplyr::mutate(
  #     n = dplyr::case_match(
  #       spatial_unit,
  #       5 ~ (n_tot - sum),
  #       .default = n
  #     )) |>
  #   dplyr::mutate(spatial_unit = as.character(spatial_unit)) |>
  #   dplyr::select(-n_tot, -sum) |>
  #   # dplyr::filter(age < 51) |>
  #   constructive::construct()

  population_short_5r <- tibble::tibble(
    year = rep(2023, 2020L),
    spatial_unit = rep(c("1", "2", "3", "4", "5"), 404),
    nat = rep(c("ch", "int"), each = 1010L),
    sex = rep(rep(c("m", "f"), 2), each = 505L),
    age = rep(rep(seq(0, 100, by = 1), 4), each = 5L),
    n = c(
      711, 593, 474, 356, 237, 763, 636, 508, 381, 254, 867, 723, 578, 434, 289,
      830, 692, 553, 415, 276, 838, 698, 559, 419, 280, 835, 696, 556, 417, 278,
      836, 697, 557, 418, 279, 818, 682, 545, 409, 272, 851, 709, 567, 426, 284,
      860, 716, 573, 430, 287, 828, 690, 552, 414, 276, 830, 692, 553, 415, 276,
      840, 700, 560, 420, 279, 847, 706, 565, 423, 282, 812, 677, 541, 406, 271,
      830, 692, 554, 415, 277, 798, 665, 532, 399, 266, 823, 686, 549, 412, 274,
      828, 690, 552, 414, 275, 830, 692, 553, 415, 277, 819, 682, 546, 410, 273,
      806, 672, 537, 403, 268, 792, 660, 528, 396, 263, 862, 718, 574, 431, 287,
      844, 703, 562, 422, 281, 862, 718, 575, 431, 288, 870, 725, 580, 435, 289,
      918, 765, 612, 459, 306, 847, 706, 565, 423, 282, 853, 711, 569, 427, 284,
      926, 771, 617, 463, 308, 957, 797, 638, 478, 319, 949, 790, 632, 474, 317,
      958, 798, 638, 479, 319, 958, 798, 639, 479, 319, 959, 799, 639, 480, 320,
      949, 791, 633, 475, 316, 979, 816, 652, 489, 326, 939, 782, 626, 470, 313,
      984, 820, 656, 492, 328, 979, 816, 653, 489, 326, 990, 825, 660, 495, 330,
      981, 817, 654, 490, 327, 986, 822, 658, 493, 329, 939, 783, 626, 470, 313,
      927, 773, 618, 464, 309, 926, 772, 617, 463, 309, 879, 733, 586, 440, 293,
      902, 752, 602, 451, 301, 958, 798, 639, 479, 320, 973, 810, 648, 486, 325,
      1011, 843, 674, 506, 337, 1066, 889, 711, 533, 356, 1112, 927, 741, 556, 371,
      1132, 943, 755, 566, 377, 1208, 1007, 806, 604, 403, 1232, 1026, 821, 616,
      411, 1240, 1033, 827, 620, 413, 1269, 1058, 846, 635, 423, 1286, 1072, 857,
      643, 428, 1221, 1018, 814, 610, 407, 1212, 1010, 808, 606, 405, 1173, 978,
      782, 586, 391, 1115, 929, 743, 557, 372, 1083, 902, 722, 541, 361, 1033, 861,
      689, 516, 344, 1025, 854, 683, 512, 342, 983, 819, 655, 492, 328, 966, 805,
      644, 483, 321, 916, 764, 611, 458, 305, 893, 744, 595, 447, 298, 860, 716,
      573, 430, 286, 792, 660, 528, 396, 265, 802, 668, 534, 401, 267, 766, 638,
      510, 383, 255, 775, 646, 516, 387, 258, 746, 621, 497, 373, 248, 722, 602,
      481, 361, 240, 674, 562, 449, 337, 224, 634, 528, 423, 317, 212, 600, 500,
      400, 300, 201, 514, 429, 343, 257, 172, 467, 389, 311, 233, 156, 361, 301,
      241, 181, 120, 330, 275, 220, 165, 110, 319, 266, 213, 160, 106, 274, 229,
      183, 137, 92, 224, 186, 149, 112, 75, 206, 172, 138, 103, 69, 176, 147, 117,
      88, 59, 134, 112, 89, 67, 44, 117, 97, 78, 58, 39, 91, 76, 60, 45, 30, 70, 58,
      47, 35, 24, 46, 38, 31, 23, 15, 35, 30, 24, 18, 11, 22, 19, 15, 11, 8, 10, 9,
      7, 5, 4, 10, 8, 7, 5, 3, 4, 4, 3, 2, 2, 7, 6, 5, 3, 2, 686, 572, 457, 343,
      228, 730, 608, 487, 365, 244, 806, 671, 537, 403, 268, 760, 633, 507, 380,
      253, 773, 644, 515, 387, 258, 783, 652, 522, 391, 261, 801, 668, 534, 401,
      267, 798, 665, 532, 399, 266, 793, 660, 528, 396, 265, 780, 650, 520, 390,
      259, 774, 645, 516, 387, 258, 796, 663, 531, 398, 265, 780, 650, 520, 390,
      260, 829, 691, 553, 414, 276, 774, 645, 516, 387, 259, 805, 671, 537, 402,
      268, 765, 637, 510, 382, 255, 769, 641, 513, 385, 256, 758, 632, 505, 379,
      253, 783, 653, 522, 392, 261, 771, 642, 514, 385, 257, 766, 638, 511, 383,
      255, 764, 637, 510, 382, 255, 799, 666, 532, 399, 266, 830, 692, 553, 415,
      276, 817, 681, 545, 408, 272, 854, 711, 569, 427, 284, 860, 716, 573, 430,
      287, 867, 723, 578, 434, 289, 884, 736, 589, 442, 295, 881, 734, 587, 440,
      294, 956, 796, 637, 478, 319, 952, 793, 634, 476, 317, 980, 817, 654, 490,
      327, 945, 787, 630, 472, 315, 980, 817, 653, 490, 327, 971, 810, 648, 486,
      323, 972, 810, 648, 486, 324, 955, 796, 637, 478, 318, 986, 822, 658, 493,
      329, 982, 818, 654, 491, 327, 1012, 844, 675, 506, 338, 1022, 852, 682, 511,
      341, 982, 818, 654, 491, 327, 967, 806, 645, 484, 322, 910, 758, 607, 455,
      304, 941, 784, 627, 471, 314, 993, 827, 662, 496, 331, 955, 796, 637, 478,
      318, 957, 798, 638, 478, 319, 973, 810, 648, 486, 325, 1023, 852, 682, 512,
      341, 1118, 932, 745, 559, 373, 1160, 967, 773, 580, 387, 1172, 976, 781, 586,
      390, 1263, 1053, 842, 632, 421, 1262, 1052, 841, 631, 421, 1292, 1077, 861,
      646, 431, 1286, 1072, 857, 643, 429, 1320, 1100, 880, 660, 439, 1289, 1074,
      859, 645, 430, 1243, 1036, 829, 621, 414, 1216, 1014, 811, 608, 405, 1185,
      987, 790, 592, 395, 1125, 938, 750, 563, 375, 1120, 933, 746, 560, 373, 1115,
      929, 743, 557, 372, 1057, 881, 705, 529, 352, 1028, 856, 685, 514, 342, 982,
      818, 654, 491, 327, 950, 792, 634, 475, 317, 949, 791, 633, 474, 316, 885,
      737, 590, 442, 295, 889, 741, 593, 444, 296, 858, 715, 572, 429, 286, 833,
      694, 556, 417, 278, 814, 678, 542, 407, 271, 803, 669, 535, 401, 268, 768,
      640, 512, 384, 257, 740, 617, 494, 370, 247, 715, 596, 477, 358, 238, 629,
      524, 419, 315, 210, 561, 468, 374, 280, 187, 491, 410, 328, 246, 163, 467,
      389, 311, 233, 156, 430, 358, 286, 215, 143, 382, 319, 255, 191, 128, 378,
      315, 252, 189, 125, 318, 265, 212, 159, 105, 293, 244, 196, 147, 98, 242, 202,
      161, 121, 80, 216, 180, 144, 108, 71, 168, 140, 112, 84, 56, 142, 118, 95, 71,
      47, 113, 94, 76, 57, 38, 86, 72, 57, 43, 28, 61, 51, 41, 30, 20, 44, 37, 30,
      22, 15, 29, 24, 19, 15, 10, 20, 17, 13, 10, 7, 25, 20, 16, 12, 9, 284, 236,
      189, 142, 94, 337, 281, 225, 168, 112, 347, 289, 231, 174, 116, 341, 284, 227,
      171, 114, 348, 290, 232, 174, 115, 357, 297, 238, 178, 119, 343, 286, 229,
      171, 114, 368, 307, 246, 184, 123, 336, 280, 224, 168, 113, 349, 290, 232,
      174, 117, 334, 278, 223, 167, 111, 347, 289, 231, 173, 116, 332, 276, 221,
      166, 111, 301, 251, 201, 151, 100, 300, 250, 200, 150, 100, 322, 269, 215,
      161, 108, 286, 238, 191, 143, 96, 323, 269, 215, 161, 108, 319, 266, 213, 160,
      106, 290, 242, 194, 145, 97, 276, 230, 184, 138, 91, 288, 240, 192, 144, 96,
      296, 246, 197, 148, 99, 349, 290, 232, 174, 117, 369, 308, 246, 185, 123, 413,
      344, 276, 207, 138, 455, 379, 303, 228, 152, 490, 409, 327, 245, 164, 491,
      410, 328, 246, 163, 531, 442, 354, 265, 177, 570, 475, 380, 285, 189, 587,
      489, 391, 293, 196, 625, 520, 416, 312, 209, 668, 556, 445, 334, 223, 654,
      545, 436, 327, 217, 645, 537, 430, 322, 215, 688, 573, 459, 344, 229, 673,
      561, 449, 337, 224, 674, 562, 450, 337, 225, 696, 580, 464, 348, 233, 665,
      554, 443, 332, 222, 676, 563, 451, 338, 225, 671, 559, 447, 335, 224, 653,
      544, 435, 326, 218, 626, 522, 417, 313, 208, 615, 513, 410, 308, 205, 578,
      482, 386, 289, 193, 564, 470, 376, 282, 187, 535, 446, 357, 268, 178, 518,
      432, 345, 259, 172, 507, 422, 338, 254, 169, 508, 424, 339, 254, 169, 478,
      398, 318, 239, 159, 463, 386, 308, 231, 154, 471, 392, 314, 236, 157, 459,
      382, 306, 229, 153, 460, 383, 306, 230, 153, 452, 376, 301, 226, 151, 450,
      375, 300, 225, 151, 424, 354, 283, 212, 142, 382, 318, 254, 191, 127, 340,
      283, 226, 170, 113, 306, 255, 204, 153, 103, 302, 252, 201, 151, 101, 245,
      204, 163, 123, 82, 226, 188, 151, 113, 75, 188, 157, 126, 94, 63, 178, 148,
      118, 89, 59, 170, 142, 113, 85, 57, 148, 124, 99, 74, 50, 129, 108, 86, 64,
      43, 121, 101, 81, 60, 40, 119, 100, 80, 60, 39, 132, 110, 88, 66, 44, 107, 89,
      71, 54, 36, 111, 92, 74, 55, 37, 94, 78, 63, 47, 31, 93, 78, 62, 46, 31, 73,
      60, 48, 36, 25, 84, 70, 56, 42, 29, 79, 66, 53, 39, 26, 82, 69, 55, 41, 28,
      62, 52, 42, 31, 21, 70, 58, 47, 35, 24, 61, 50, 40, 30, 21, 50, 42, 33, 25,
      16, 35, 30, 24, 18, 11, 37, 31, 25, 19, 12, 28, 24, 19, 14, 10, 17, 14, 12, 9,
      6, 12, 10, 8, 6, 5, 6, 5, 4, 3, 1, 5, 4, 4, 3, 2, 3, 3, 2, 2, 1, 5, 4, 3, 2,
      2, 2, 2, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
      0, 0, 0, 0, 1, 278, 232, 186, 139, 93, 292, 244, 195, 146, 97, 330, 275, 220,
      165, 110, 344, 286, 229, 172, 114, 328, 274, 219, 164, 109, 322, 269, 215,
      161, 108, 315, 262, 210, 157, 105, 338, 282, 226, 169, 113, 319, 266, 213,
      160, 106, 327, 272, 218, 163, 109, 307, 256, 205, 153, 102, 312, 260, 208,
      156, 103, 280, 233, 187, 140, 93, 307, 256, 205, 153, 102, 287, 240, 192, 144,
      95, 276, 230, 184, 138, 92, 265, 221, 177, 133, 88, 242, 202, 162, 121, 81,
      250, 208, 166, 125, 83, 239, 200, 160, 120, 79, 230, 192, 153, 115, 76, 234,
      195, 156, 117, 78, 245, 204, 164, 123, 82, 284, 237, 190, 142, 95, 308, 257,
      206, 154, 103, 349, 290, 232, 174, 117, 395, 329, 263, 198, 132, 415, 346,
      276, 207, 138, 454, 379, 303, 227, 152, 471, 393, 314, 236, 157, 500, 417,
      334, 250, 167, 538, 448, 358, 269, 179, 542, 452, 362, 271, 181, 576, 480,
      384, 288, 191, 574, 478, 383, 287, 191, 587, 490, 392, 294, 195, 590, 492,
      393, 295, 196, 596, 496, 397, 298, 199, 601, 500, 400, 300, 201, 592, 493,
      395, 296, 197, 590, 492, 393, 295, 196, 596, 496, 397, 298, 199, 574, 478,
      382, 287, 191, 562, 468, 375, 281, 187, 514, 428, 343, 257, 172, 533, 444,
      355, 266, 178, 490, 408, 327, 245, 164, 463, 386, 308, 231, 154, 470, 392,
      314, 235, 157, 446, 371, 297, 223, 148, 418, 348, 278, 209, 139, 444, 370,
      296, 222, 149, 417, 348, 278, 208, 139, 384, 320, 256, 192, 129, 391, 326,
      261, 195, 130, 366, 305, 244, 183, 122, 367, 306, 245, 183, 122, 354, 295,
      236, 177, 119, 324, 270, 216, 162, 107, 329, 274, 220, 165, 110, 294, 245,
      196, 147, 98, 263, 219, 175, 131, 88, 247, 206, 165, 124, 82, 248, 207, 165,
      124, 83, 209, 174, 139, 104, 70, 192, 160, 128, 96, 64, 162, 135, 108, 81, 55,
      153, 127, 102, 76, 51, 155, 129, 103, 78, 52, 150, 125, 100, 75, 50, 134, 111,
      89, 67, 44, 121, 101, 81, 60, 40, 115, 96, 76, 57, 38, 112, 94, 75, 56, 37,
      108, 90, 72, 54, 36, 112, 94, 75, 56, 37, 79, 66, 53, 39, 26, 88, 73, 58, 44,
      29, 69, 58, 46, 34, 23, 72, 60, 48, 36, 25, 60, 50, 40, 30, 19, 70, 58, 47,
      35, 24, 62, 52, 41, 31, 21, 68, 56, 45, 34, 23, 61, 51, 41, 31, 20, 47, 39,
      31, 23, 16, 46, 38, 30, 23, 15, 28, 23, 19, 14, 9, 28, 23, 19, 14, 9, 18, 15,
      12, 9, 6, 18, 15, 12, 9, 5, 10, 8, 7, 5, 4, 9, 8, 6, 4, 3, 6, 5, 4, 3, 3, 6,
      5, 4, 3, 3, 4, 3, 3, 2, 1, 3, 2, 2, 2, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0,
      0, 0, 1, 0, 0, 0, 0, 1
    ),
  )

  # run propop 5 regions with subregional migration ----
  output_propop_5r <- propop(
    parameters = parameters_short_5r,
    year_first = 2024,
    year_last = 2024,
    age_groups = 101,
    fert_first = 16,
    fert_last = 50,
    share_born_female = 100 / 205,
    population = population_short_5r,
    binational = TRUE,
    subregional = TRUE
  )


  # run snapshot 5 subregions ----
  expect_snapshot(constructive::construct(output_propop_5r))


  # run propop 5 regions without subregional migration ----
  output_propop_5r_F <- propop(
    parameters = parameters_short_5r,
    year_first = 2024,
    year_last = 2024,
    age_groups = 101,
    fert_first = 16,
    fert_last = 50,
    share_born_female = 100 / 205,
    population = population_short_5r,
    binational = TRUE,
    subregional = FALSE
  )

    # Check if components add up
  balance_check <- check_balance(output_propop_5r_F)

  expect_equal(balance_check$nonzeros, 0, info =
                 "The components don't add up in at least one row")
  expect_equal(balance_check$missings, 0, info =
                 "There are missings in at least one row")

  # Remove additional column to enable fair comparison
  output_propop_5r_T <- output_propop_5r |>
    dplyr::select(-mig_sub)

  # Ensure that results with / without subregional are different ----
  expect_failure(expect_equal(output_propop_5r_T, output_propop_5r_F))

  # prepare comparison 1 vs 5 regions ----

  ## prepare data for comparison ----
  ### n in starting populations should be identical in both versions
  ### simplify to make comparable
  compare_pop1r <- population_short_1r |>
    select(-spatial_unit) |>
    arrange(year, nat, sex, age)
  ### simplify to make comparable
  compare_pop5r <- population_short_5r |>
    summarise(n = sum(n), .by = c(year, nat, sex, age)) |>
    arrange(year, nat, sex, age)



  # run equal starting populations ----
  expect_equal(compare_pop1r, compare_pop5r)


  ### parameters should be identical in both versions
  compare_params_1r <- parameters_short_1r |>
    dplyr::select(-spatial_unit) |>
    arrange(year, nat, sex, age)

  compare_params_5r <- parameters_short_5r |>
    # remove column that includes redundancy
    dplyr::select(-mig_sub, -spatial_unit) |>
    # remove redundant columns
    dplyr::distinct(year, nat, sex, age, .keep_all = TRUE) |>
    # multiply columns with number-of-people parameters
    # by number of regions to get the n right again
    dplyr::mutate_at(vars(imm_int_n, imm_nat_n, emi_nat_n, mig_nat_n), ~ . * 5) |>
    arrange(year, nat, sex, age)

  # run equal parameters ----
  expect_equal(compare_params_1r, compare_params_5r)


  ## equal projection results
  # simplify data for comparison
  output_super <- output_propop_1r |>
    select(year, age, sex, nat, n_dec) |>
    arrange(year, nat, sex, age)

  output_subregions <- output_propop_5r |>
    dplyr::mutate(n_check = sum(n_dec, na.rm = TRUE),
                  .by = c(year, nat, sex, age)) |>
    # remove column that includes redundancy
    dplyr::select(-n_dec, -spatial_unit) |>
    # rename n_check
    rename(n_dec = n_check) |>
    # remove redundant columns
    dplyr::distinct(year, nat, sex, age, .keep_all = TRUE) |>
    select(year, age, sex, nat, n_dec) |>
    arrange(year, nat, sex, age)

  # run equal output ----
  expect_equal(output_super, output_subregions, ignore_attr = TRUE)
})

options(cli.default_handler = NULL)



# Unexpected input regarding nationalities ----

test_that("Error when binational is FALSE but column `nat` is present", {

  expect_error(
    propop(
      parameters = fso_parameters,
      year_first = 2024,
      year_last = 2024,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population,
      binational = FALSE,
      subregional = FALSE
    )
  )
})


test_that("Error when only 1 nationality in parameters", {

  expect_error(
    propop(
      # remove non-Swiss nationals
      parameters = fso_parameters |>
        # remove non-Swiss nationals
        dplyr::filter(nat != "int"),
      year_first = 2024,
      year_last = 2024,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population,
      binational = TRUE,
      subregional = FALSE
    )
  )
})

test_that("Error when only 1 nationality in population", {

  expect_error(
    propop(
      # remove non-Swiss nationals
      parameters = fso_parameters,
      year_first = 2024,
      year_last = 2024,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population |>
        # remove Swiss nationals
        dplyr::filter(nat == "int"),
      binational = TRUE,
      subregional = FALSE
    )
  )
})

test_that("Error if there are unexpected factor levels in pop `nat`", {

  expect_error(
    propop(
      # remove non-Swiss nationals
      parameters = fso_parameters,
      year_first = 2024,
      year_last = 2024,
      fert_first = 16,
      fert_last = 50,
      share_born_female = 100 / 205,
      population = fso_population |>
        # replace factor level
        dplyr::mutate(nat = case_match(
          nat,
          "ch" ~ "swiss",
          .default = nat)),
      binational = TRUE,
      subregional = FALSE
    )
  )
})
