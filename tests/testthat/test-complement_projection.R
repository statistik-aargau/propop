test_that("snapshot test complement_projection()", {
  skip_on_ci()

  # create skeleton with variable labels and levels
  # prepare_skeleton(
  #   age_groups = 101,
  #   year_first = 2024,
  #   year_last = 2024,
  #   spatial_unit = "Canton"
  # ) |>
  #   constructive::construct()

  empty_df <- tibble::tibble(
    age = rep(0:100, 8),
    sex = factor(rep(rep(c("m", "f"), 4), each = 101L), levels = c("m", "f")),
    nat = factor(rep(rep(c("ch", "int"), 2), each = 202L)),
    year = rep(2023:2024, each = 404L)
  ) |>
    structure(
      out.attrs = list(
        dim = c(age = 101L, sex = 2L, nat = 2L, year = 2L),
        dimnames = list(
          age = c(
            "age=  0", "age=  1", "age=  2", "age=  3", "age=  4", "age=  5", "age=  6",
            "age=  7", "age=  8", "age=  9", "age= 10", "age= 11", "age= 12", "age= 13",
            "age= 14", "age= 15", "age= 16", "age= 17", "age= 18", "age= 19", "age= 20",
            "age= 21", "age= 22", "age= 23", "age= 24", "age= 25", "age= 26", "age= 27",
            "age= 28", "age= 29", "age= 30", "age= 31", "age= 32", "age= 33", "age= 34",
            "age= 35", "age= 36", "age= 37", "age= 38", "age= 39", "age= 40", "age= 41",
            "age= 42", "age= 43", "age= 44", "age= 45", "age= 46", "age= 47", "age= 48",
            "age= 49", "age= 50", "age= 51", "age= 52", "age= 53", "age= 54", "age= 55",
            "age= 56", "age= 57", "age= 58", "age= 59", "age= 60", "age= 61", "age= 62",
            "age= 63", "age= 64", "age= 65", "age= 66", "age= 67", "age= 68", "age= 69",
            "age= 70", "age= 71", "age= 72", "age= 73", "age= 74", "age= 75", "age= 76",
            "age= 77", "age= 78", "age= 79", "age= 80", "age= 81", "age= 82", "age= 83",
            "age= 84", "age= 85", "age= 86", "age= 87", "age= 88", "age= 89", "age= 90",
            "age= 91", "age= 92", "age= 93", "age= 94", "age= 95", "age= 96", "age= 97",
            "age= 98", "age= 99", "age=100"
          ),
          sex = c("sex=m", "sex=f"),
          nat = c("nat=ch", "nat=int"),
          year = c("year=2023", "year=2024")
        )
      )
    )

  # # create df with raw projection results
  # project_raw(
  #   parameters = fso_parameters |>
  #     dplyr::filter(year == 2025 &
  #                     scen == "reference"),
  #   year_first = 2025,
  #   year_last = 2025,
  #   age_groups = 101,
  #   fert_first = 16,
  #   fert_last = 50,
  #   share_born_female = 100 / 205,
  #   n = fso_population |> dplyr::pull(n),
  #   subregional = FALSE
  # ) |>
  #   constructive::construct()

  raw_df <- data.frame(
    scen = factor(rep("reference", 808L)),
    spatial_unit = factor(rep("Aargau", 808L)),
    N = c(
      2371, 2542, 2891, 2766, 2794, 2782, 2787, 2726, 2837, 2866, 2760, 2766, 2799,
      2823, 2707, 2768, 2660, 2744, 2759, 2767, 2730, 2686, 2639, 2872, 2812, 2874,
      2899, 3060, 2823, 2844, 3085, 3189, 3162, 3192, 3193, 3197, 3164, 3262, 3130,
      3280, 3263, 3300, 3269, 3288, 3131, 3091, 3087, 2931, 3008, 3194, 3242, 3371,
      3555, 3707, 3773, 4028, 4106, 4133, 4231, 4286, 4070, 4041, 3910, 3716, 3609,
      3443, 3416, 3277, 3219, 3054, 2977, 2865, 2641, 2672, 2552, 2582, 2485, 2406,
      2246, 2114, 2001, 1715, 1556, 1204, 1100, 1064, 915, 746, 688, 587, 446, 389,
      302, 234, 153, 118, 75, 35, 33, 15, 23, 2286, 2434, 2685, 2533, 2577, 2609,
      2671, 2660, 2642, 2599, 2580, 2653, 2600, 2763, 2581, 2683, 2549, 2564, 2527,
      2611, 2569, 2553, 2548, 2662, 2766, 2723, 2845, 2866, 2891, 2946, 2936, 3186,
      3172, 3268, 3149, 3267, 3238, 3240, 3184, 3288, 3272, 3375, 3408, 3272, 3224,
      3034, 3137, 3309, 3184, 3190, 3242, 3410, 3727, 3867, 3905, 4211, 4207, 4307,
      4287, 4399, 4297, 4143, 4054, 3949, 3751, 3732, 3716, 3524, 3425, 3272, 3168,
      3163, 2949, 2963, 2860, 2778, 2712, 2676, 2561, 2468, 2384, 2097, 1870, 1638,
      1556, 1432, 1275, 1259, 1059, 978, 806, 719, 560, 473, 378, 286, 203, 148, 97,
      67, 82, 945, 1123, 1157, 1137, 1159, 1189, 1143, 1228, 1121, 1162, 1113, 1156,
      1106, 1004, 1000, 1075, 954, 1076, 1064, 968, 919, 960, 986, 1162, 1231, 1378,
      1517, 1635, 1638, 1769, 1899, 1956, 2082, 2226, 2179, 2149, 2293, 2244, 2248,
      2321, 2216, 2253, 2236, 2176, 2086, 2051, 1928, 1879, 1784, 1726, 1690, 1694,
      1592, 1542, 1570, 1529, 1532, 1506, 1501, 1415, 1272, 1132, 1021, 1007, 817,
      753, 628, 592, 567, 495, 430, 403, 398, 440, 357, 369, 313, 310, 242, 281,
      263, 275, 208, 234, 202, 166, 118, 124, 95, 58, 41, 19, 18, 11, 16, 7, 3, 0,
      0, 0, 1, 928, 974, 1100, 1145, 1094, 1075, 1049, 1128, 1064, 1089, 1023, 1039,
      933, 1023, 958, 920, 884, 808, 832, 798, 766, 780, 818, 948, 1028, 1162, 1317,
      1382, 1515, 1571, 1668, 1792, 1808, 1919, 1913, 1958, 1966, 1986, 2002, 1973,
      1966, 1986, 1912, 1873, 1714, 1776, 1634, 1542, 1568, 1485, 1392, 1481, 1390,
      1281, 1303, 1220, 1223, 1181, 1079, 1098, 980, 876, 824, 827, 696, 640, 541,
      509, 517, 500, 445, 403, 382, 374, 360, 374, 263, 292, 230, 241, 199, 234,
      207, 226, 204, 156, 152, 93, 93, 60, 59, 34, 30, 21, 21, 13, 10, 4, 3, 1, 1,
      2490.812819419818, 2434.6816559365097, 2589.3959258214463, 2928.4883856244624,
      2805.986206, 2827.331744, 2813.0091230000003, 2815.430735, 2759.3442539999996,
      2867.732046, 2900.6946140000005, 2799.457461, 2810.360714, 2848.2166709999997,
      2872.916184, 2758.76939, 2821.614352107772, 2705.391824915994,
      2779.369737455392, 2767.1500279785105, 2764.003009218962, 2723.5569879621517,
      2681.179522755897, 2634.4331911884697, 2854.0163024736994, 2795.5084644267276,
      2847.289003338671, 2877.203199335264, 3038.62324464756, 2831.5999254524418,
      2863.3080295404798, 3108.689234839672, 3220.7939228528, 3209.9122843392242,
      3248.2339303856684, 3251.6913614344403, 3253.5251885950447,
      3223.3566493482513, 3315.547178100392, 3184.9268464153906, 3329.187178085312,
      3311.595527962436, 3343.265299300678, 3311.9242858803937, 3325.4092500804,
      3170.059363461152, 3125.75683132541, 3117.824239960794, 2964.261068693912,
      3034.93885425904, 3216.8076801647126, 3263.1493414449283, 3390.424946833424,
      3568.350700761575, 3717.375924763442, 3780.4453530243245, 4027.7443859044474,
      4100.913738377405, 4124.4591975314, 4219.439183767853, 4270.420068762653,
      4054.680192595991, 4022.371397094325, 3892.3515706914222, 3693.4390705587152,
      3563.295631121123, 3418.2045172061207, 3388.664893137048, 3245.97607152418,
      3183.447803070321, 3017.26881169872, 2938.539709616256, 2823.467428824002,
      2600.967111235236, 2625.388937449396, 2501.6563823076217, 2524.78891122318,
      2422.011785154704, 2336.4383381296598, 2171.170597337028, 2033.5492958845718,
      1911.43756938489, 1628.7500090823098, 1463.315204132496, 1123.5695079406842,
      1014.5299581965999, 968.103994009924, 822.251826825275, 662.615269978065,
      602.2516220661199, 507.8006964922315, 380.8474701278, 327.183715539814,
      248.328966997938, 188.56128198135602, 119.604204907622, 89.243754, 54.545475,
      24.62964, 22.000011, 23.644436, 2376.2803965986504, 2329.7356335382337,
      2475.214774149971, 2720.8761517320004, 2575.450272, 2606.9256259999997,
      2637.5080860000003, 2696.901718, 2686.593868, 2670.8514560000003, 2630.074153,
      2614.4120529999996, 2688.1912370000005, 2636.928791, 2807.3385820000003,
      2628.4341480000003, 2728.8554670000003, 2593.257848, 2602.054516, 2560.156339,
      2635.488186, 2582.648566, 2553.072217, 2542.86596, 2644.6597225000005,
      2750.730636952643, 2711.7133070357995, 2828.0657525127517, 2857.275614116663,
      2897.38874514646, 2958.550065804348, 2964.4249810562237, 3220.0015463579252,
      3221.47017394232, 3323.99616134604, 3216.714728055656, 3332.5341913026177,
      3305.817376766378, 3303.2379945636003, 3249.389895692403, 3346.5572748993104,
      3327.075388271552, 3423.4385583309545, 3450.0052016031195, 3310.058782777408,
      3258.6226010955997, 3067.3802442718675, 3162.68726070442, 3326.4744425832628,
      3204.4558327914237, 3207.0683650399496, 3259.245740588512, 3425.8898182018465,
      3736.430329258848, 3872.8772656769656, 3906.7094320462393, 4208.823502747803,
      4202.108578960684, 4299.248603596572, 4278.62003203525, 4389.525737701983,
      4286.877445664797, 4131.711022805387, 4041.993234157116, 3925.665573069488,
      3730.3957700039045, 3712.8336549838245, 3693.6412404472317, 3499.42247985575,
      3400.1099543812797, 3245.833549949992, 3139.088542129895, 3132.5315238595836,
      2917.064756634558, 2925.134555223375, 2821.2053518353605, 2734.8312448978,
      2666.4653230787003, 2624.7170346826683, 2504.6331114532004, 2406.0099057331,
      2313.6493745374078, 2027.139898655707, 1798.614589297555, 1564.735242547,
      1474.3070080994141, 1341.585898897208, 1181.9958069523125, 1149.623322509018,
      954.06884820474, 864.736654292449, 699.6135386484001, 611.6018519482151,
      465.41514976832, 384.0589300824, 297.63482368275, 220.3153635, 151.832521,
      106.56, 67.716961, 96.64001150000001, 1176.9565593713523, 964.13686776738,
      1128.304185, 1164.190091, 1150.514451, 1169.494839, 1201.1074879999999,
      1158.474828, 1240.126824, 1136.9135159999998, 1171.832974, 1121.667914,
      1157.345476, 1104.503308, 1001.385412, 995.084775, 1063.358904210075,
      951.4020236606999, 1075.583543088352, 1088.5320443910398, 1010.5469396243,
      978.840874232206, 1030.25370664128, 1074.220615707358, 1250.104509176284,
      1335.5544416892312, 1487.1299476112451, 1627.1607870557748, 1747.1400985982,
      1759.980660398928, 1885.4829969092236, 2007.343251490254, 2064.68616821176,
      2179.007329649294, 2309.4825407543512, 2262.711239385467, 2228.956291258338,
      2357.8389964532353, 2300.399083343922, 2297.83593167786, 2358.0540407167123,
      2247.947321581864, 2273.500642361492, 2251.636295300572, 2187.895392858624,
      2098.60588936831, 2057.788199079711, 1936.14986810872, 1884.283853560142,
      1789.9784840125162, 1730.464124892711, 1692.2504123334602, 1689.6054045469548,
      1590.325643892196, 1538.4578467321571, 1559.2397615240802, 1513.48748111099,
      1507.895367678096, 1473.9995094096, 1469.5215953381198, 1377.9175270081123,
      1248.90865019436, 1104.79342272704, 989.558687123245, 959.5711776466261,
      760.4680467575815, 710.218866979624, 612.638316445978, 578.703085543408,
      555.3883971065205, 482.23222186154993, 420.85390964208, 392.5690916094865,
      387.780400811818, 425.9054334201, 346.614695942904, 358.135111565886,
      303.7192234533825, 300.71831611513, 234.469669921167, 268.735028700752,
      251.2887461769075, 262.95462819482503, 198.67339191783998, 223.24094949605,
      191.217082593808, 154.70152756729598, 108.10317048355999, 111.48626291480801,
      83.9732058739325, 48.91564681336, 33.620000000000005, 14.969701, 13.199994,
      8.461541, 10, 4.454547999999999, 1.7999999999999998, 0, 0, 1,
      1132.6054828378888, 958.691822715056, 994.869594, 1112.6007, 1155.18842,
      1106.1699820000001, 1088.4859999999999, 1063.799196, 1137.141808, 1072.169104,
      1091.177161, 1023.365592, 1033.237502, 926.418162, 1003.1340749999999,
      934.85454, 896.92948, 862.8163959999999, 792.816728, 825.918528, 812.440734,
      807.27213, 844.37764, 901.75824, 1041.887936, 1133.319243, 1268.8853684511141,
      1424.360105378751, 1495.6298306792978, 1618.9148771781975, 1669.567758434755,
      1750.60176266625, 1861.7647562649602, 1871.013571936768, 1967.524663142936,
      1956.6873397195175, 1992.873467802082, 1996.6401218421402, 2010.4036570004,
      2018.28117745928, 1987.2701918413647, 1975.7860459914082, 1987.28266350021,
      1913.698530533156, 1873.9226857967253, 1718.424778768412, 1773.202378056752,
      1636.310437811216, 1548.0132023908532, 1570.047079544832, 1488.4090105166702,
      1396.91572871724, 1480.5334111920852, 1391.54676828596, 1284.263393677524,
      1302.1630783931287, 1212.2995734527801, 1207.545943982241, 1160.271290517093,
      1056.9475219448448, 1068.7889227650842, 956.3708187856001, 855.716050159152,
      803.312512821252, 797.6054308106051, 682.9182923317601, 630.44289466112,
      534.6575301671975, 504.60583993502354, 512.7083886076609, 493.25323979200004,
      439.14150288123744, 397.87525222973954, 377.375467776112, 369.08889664705595,
      354.241966791, 367.43247096307203, 259.12317929579353, 285.85478937732006,
      225.14293961372002, 234.357356485952, 193.48202667544, 227.353253907744,
      198.99770641828053, 217.691121, 194.65323175137598, 147.57720319488004,
      141.58342155746, 85.343943469047, 84.26418322214599, 53.829348622450006,
      51.09095373745001, 29.077958911242, 23.793084945555, 16.6249887832455,
      16.058826, 9.941178, 7, 2.857144, 2.000001, 1.5
    ),
    BIRTHS = rep(
      c(
        2467.882367859484, 0, 2350.3641598661757, 0, 1161.9093432064913, 0,
        1106.5803268633242, 0, NA
      ),
      c(1L, 100L, 1L, 100L, 1L, 100L, 1L, 100L, 404L)
    ),
    MOR = rep(
      c(
        8.013359665293946, 0.9568540634900001, 1.035651178554, 1.0947323755379998, 0,
        0.003949, 1.003431892228, 0.9419870840060001, 1.0163745446080001,
        0.9921530214894999, 0.9985477810385, 0.9874200378480001, 0.985295244103,
        0.98402881153, 1.0864675263, 0.9848305732725001, 1.026658661329,
        1.0164866647359998, 1.05981535244, 0.9322785475579999, 1.00424045952,
        1.0724961603285001, 1.0507471471999998, 1.963237660776, 1.9868616143320001,
        1.9662305655599999, 1.9679424049549998, 1.9459836517484999, 2.025547899608,
        1.8931355846090003, 2.0581339146879998, 1.9733900375639999,
        2.9937446993220003, 2.9334461196059998, 2.9772379196, 2.8358125388479998,
        3.9040046745900003, 3.9519410392065, 3.7715683060875, 5.07928974096,
        5.263503835288001, 6.049532555071999, 7.234385166576, 8.383970238424999,
        9.355369236558, 11.177597975676, 13.850540095552999, 15.291331622595,
        17.1337824686, 18.456445232147505, 21.334049237348005, 21.949621404009,
        22.940683905675503, 24.327640308577006, 24.866924441285, 26.4269138788775,
        27.08219879388, 29.003862862952, 30.974288475820003, 32.745813929679,
        33.60494830128, 35.549954383743994, 39.032817175998, 39.33141976476399,
        45.265534550604, 48.647855692377995, 55.785498776820006, 61.091602845296,
        68.65481787034, 74.128430662972, 79.96210811542801, 88.70258561511,
        87.24741091769, 92.019939867504, 81.662128059316, 85.5541418034,
        94.63878199007601, 92.00755817472502, 83.744996021935, 86.66029793388,
        80.24283250776851, 65.3863698722, 62.786990460186004, 53.744799002061995,
        45.491252018644, 33.577551092377995, 28.756246, 20.454525, 10.37036,
        10.999989, 14.355564, 7.01297749959635, 0.9651404617660001, 1.037471850029,
        1.065188268, 0, 0.0314795, 1.038845047357, 0.9897929642000001,
        1.0452894872490002, 1.009843883337, 1.00696485354, 1.0150251956520002,
        0.9913509437760001, 1.0709436420750003, 0.9847460576799999,
        1.0145786539600001, 0.949327944344, 1.015791697382, 0.9720752336219999,
        0.9815814364, 0.976710307597, 2.0233831006899994, 1.9540997284479997,
        2.0293446690454995, 1.9892703968799998, 1.8968512225920002, 1.9537469044,
        2.7971097281320008, 3.06565929558, 3.1423124167375, 3.829991208576,
        3.9814099600500006, 4.046387411487999, 5.228295798153, 5.443541741152501,
        7.2445353230344995, 8.06560795376, 8.617762252197501, 9.999289039315999,
        11.275787403428, 11.967249964748998, 13.370374298015998, 14.6896613352025,
        15.478256194614, 16.691347842882998, 17.603962930512, 18.184999996095,
        20.019177016176002, 22.036071552768004, 22.90894914425, 24.47280561872,
        25.043358050008003, 27.355022870104996, 30.237052140415997, 31.097031365442,
        34.568919776625, 37.17232816464001, 41.403605102200004, 45.6465249213,
        51.22943731733201, 56.6503135468, 62.1432342669, 69.441441462592,
        70.78847934429301, 72.99704070244502, 74.87655745300002, 83.716395900586,
        90.57297310279199, 95.1983180476875, 110.101113490982, 107.16080779525998,
        115.20661170755099, 108.5165413516, 109.36638305178501, 95.66533023168,
        89.91938991760001, 80.37292631725, 66.6846365, 52.167479, 41.440000000000005,
        29.283039000000002, 53.35998849999999, 3.9901192578263642, 0.77437223262, 0,
        0.025224999999999997, 1.0777457899249998, 0.9034563393000001, 1.121832911648,
        0.98993160896, 0.8968603757, 0.9169427677939999, 0.98213335872,
        0.9579322926420001, 1.065118823716, 0.977701310769, 1.021342388755,
        1.0144259442249999, 0.9993014017999998, 0.9441636010719999, 1.0019060907765,
        1.003685509746, 0.97551178824, 1.0068083507060002, 1.019657245649,
        0.949718614533, 0.955367741662, 1.025468546765, 0.957952656078, 0.97994832214,
        1.0537522832879997, 1.892910418136, 2.005313638508, 1.9696326994280002,
        1.940511141376, 1.91628063169, 1.962157920289, 1.8848518912800003,
        1.9810204398579996, 2.853891987484, 2.907057107289, 2.93720766654,
        3.0123054530449997, 2.834860107804, 2.917899267843, 3.0858784759199995,
        3.9325878890099997, 4.071816321904, 5.0017385904000005, 5.10952466188,
        5.7915379918875, 5.552869805639999, 5.462857272960001, 5.5761138767550005,
        7.150858353374001, 5.968480242418501, 5.991315020376, 6.217775554022,
        6.798466456592, 6.878295893479501, 7.152603138449999, 6.243370357920001,
        6.7364293905135, 7.112513188182, 9.115166579900002, 7.532646057096,
        8.532469434113999, 7.8972115466175, 8.18937388487, 7.293096078833001,
        8.440763299248, 8.800706823092499, 9.784146805175002, 8.738736082159999,
        10.58320050395, 10.877149406192, 10.429296432704001, 9.13549351644,
        11.376161085192, 10.1785391260675, 8.38556918664, 7.38, 4.030299, 4.800006,
        2.538459, 6, 2.545452, 1.2000000000000002, 0, 2.9938380926126618,
        0.787825284944, 0, 0.091357, 1.013797548886, 1.024831621249, 0.970821320702,
        1.0088378218025, 0.9739865652450002, 1.0007373337499998, 1.02001173504,
        0.9715160632320001, 1.024037857064, 0.9738152804824999, 1.001080197918,
        0.9870181578599999, 0.9971429996, 0.99721254072, 0.980954158635,
        0.993750008592, 1.00727649979, 0.9633654668439999, 0.9805772032745002,
        0.9187852315879999, 1.0341339432480001, 0.924274188784, 0.969151609147,
        2.027928455168, 1.9005244833300001, 1.87948728276, 2.116669807915,
        1.88402171404, 1.8477023224759999, 2.0512986068715002, 2.8260065472200004,
        3.0252690177590003, 2.9356474829069996, 2.795049055155, 3.132659234916,
        3.6667812144, 2.758345840848, 2.912215178748, 4.128766189395,
        3.5033156682400004, 3.75358533888, 3.4412428328025, 2.8621170649765,
        3.0781543923389996, 3.922760208, 3.622352118762501, 3.6844047702605,
        3.8509842238879997, 3.963831352944, 4.880033209, 5.285153036928001,
        4.3034397042065, 5.63556262268, 4.8359703862800005, 5.358386514048,
        5.1160683245600005, 7.234440092256, 7.338600581719501, 9.048879,
        10.449160248623999, 8.822860805120001, 10.34861844254, 7.327458530953002,
        8.654412777853999, 6.45635137755, 7.795834262550001, 5.268187088758001,
        5.172425054445, 3.5000042167545, 4.941174, 3.058822, 3, 1.142856, 0.999999,
        0.5, NA
      ),
      rep(
        c(1L, 11L, 1L, 20L, 1L, 13L, 1L, 3L, 1L, 23L, 1L, 404L),
        c(4L, 1L, 90L, 1L, 79L, 1L, 83L, 1L, 2L, 1L, 76L, 1L)
      )
    ),
    EMI_INT = rep(
      c(
        4.007840965403802, 10.513013999999998, 11.403412000000001, 12.254949,
        11.310174, 9.963404, 9.839934000000001, 8.912825999999999, 7.744566000000001,
        8.224463, 6.99304, 5.70768, 4.940076, 4.976622, 3.966315, 3.770851,
        4.013599999999999, 5.652500000000001, 7.101472, 8.928124, 10.998825,
        12.839189999999999, 13.80604, 13.770302000000001, 15.247448, 16.720152,
        17.494038, 17.286737000000002, 18.06318, 15.774924, 15.0732, 15.076395,
        15.386925000000002, 14.706461999999998, 13.913928, 13.761829999999998, 12.788,
        12.64018, 12.157473999999999, 11.3306, 11.32584, 10.774426, 9.975900000000001,
        9.77431, 9.92976, 9.411786, 8.77844, 7.905806999999999, 7.518015,
        8.130624000000001, 8.419383999999999, 9.067874, 9.297218, 11.528865,
        12.462934, 13.194181, 14.915684, 17.319108, 19.144056, 20.494964, 19.295572,
        18.123710000000003, 17.946081, 14.58821, 13.3776, 20.546037000000002,
        15.465956, 10.996104, 10.643696, 9.920958, 8.636712, 6.909617000000001,
        5.853195, 4.6798519999999995, 4.114879999999999, 3.889248, 3.0984, 2.954665,
        1.989762, 1.924822, 1.9491079999999998, 1.970985, 0.8986600000000001,
        0.958496, 0.823536, 0.9834, 1.051232, 0.94794, 0.9101199999999999, 0,
        6.014581885097543, 10.604754, 11.422762, 11.924085, 11.142667000000001,
        11.02956, 9.003659, 9.116123, 7.8895599999999995, 6.88241, 6.814578000000001,
        5.8849800000000005, 5.0778419999999995, 4.8334, 4.188708, 3.675344, 4.083526,
        4.669768, 5.927968, 7.770525, 9.175054000000001, 11.694087999999999,
        12.854355000000002, 12.96932, 14.667620000000001, 15.633431999999999,
        14.843073, 15.718625000000001, 15.169738, 15.137276, 14.240964, 13.881408,
        13.961051999999999, 12.795848000000001, 13.186380000000002, 12.315739,
        11.186208, 9.723714, 9.81396, 9.628416000000001, 9.104472000000001, 8.795136,
        9.129375, 8.952816, 8.533376, 7.782736, 8.379908, 8.181296, 9.414105,
        8.609535999999999, 8.960709999999999, 10.102072, 10.45847, 13.055681,
        13.449426, 14.116575000000001, 15.07538, 14.993748, 14.350924, 13.958472,
        14.389129, 13.703133, 12.565719, 11.77687, 12.707882, 9.565050000000001,
        8.00514, 6.008772, 4.771496, 2.935225, 2.889176, 2.9304, 2.014831, 1.884411,
        2.032618, 1.9562400000000002, 1.969602, 0.992592, 1.0035, 0.975741,
        0.9872000000000001, 0.991744, 0.9080010000000001, 0.9237799999999999,
        0.912366, 0.9958400000000001, 0.9737600000000001, 0, 1.068891, 0,
        5.98383311751343, 34.64181, 35.023001, 30.798183, 25.375566000000003,
        22.191373000000002, 20.324766, 17.159859, 14.820732, 12.677389,
        11.262103999999999, 10.446618, 9.281524, 7.660156, 6.371384, 5.988, 6.4887,
        6.287814, 10.172504, 14.859824, 18.666912, 21.837277999999998,
        28.583039999999997, 32.579412000000005, 41.305614000000006, 46.13788,
        51.648818, 55.27492899999999, 59.290004999999994, 58.298058, 60.513952,
        62.560656, 62.404224000000006, 64.683576, 66.555174, 64.282679, 60.883319,
        63.809604, 61.061484, 59.646184000000005, 59.668268000000005, 56.505784,
        55.171464, 53.098292, 50.335232, 46.780636, 45.056368000000006, 41.280408,
        38.902816, 36.020744, 33.843408000000004, 32.25534, 32.133486, 30.14452,
        30.101382, 31.66533, 33.388773, 36.47692, 38.999376, 37.703618999999996,
        39.519535, 26.76924, 29.049384, 32.368763, 43.916276999999994, 57.81092,
        40.837449, 14.172076, 8.734368, 7.847847, 6.254325000000001, 4.45136,
        4.808999, 4.061192, 4.55972, 3.344376, 3.199599, 2.6301390000000002, 2.04631,
        1.618738, 2.412104, 1.9554049999999998, 1.087075, 0.793936, 1.17585, 0.905768,
        0.8691760000000001, 0.761336, 1.137576, 0.848255, 0.698784, 0,
        2.9932997841652917, 26.349632, 25.657108, 26.5595, 26.7472,
        22.732225999999997, 20.411025000000002, 17.338921, 15.931871999999998,
        13.112736, 13.218282, 12.190068, 11.160938, 9.954177, 11.047377, 10.516924,
        9.850439999999999, 9.866324, 10.323008, 11.555648, 11.593344,
        12.278979999999999, 14.5704, 18.436902, 22.095036, 26.663236, 30.795324,
        33.210789, 34.986712000000004, 38.611290000000004, 39.908113,
        42.127008000000004, 44.031231999999996, 42.701344, 42.097103000000004,
        39.853529, 38.038066, 36.49879000000001, 33.881159999999994, 31.919888,
        29.374024000000002, 27.787444, 27.192311999999998, 25.01852, 23.498658,
        20.142928, 20.69928, 18.421716, 16.975877999999998, 16.227232, 15.172245,
        14.050848, 14.852948999999999, 14.09738, 13.814304, 16.26144, 18.79776,
        24.198278000000002, 27.374399, 27.881359999999997, 32.263632, 28.44548,
        25.683444, 24.149792, 30.973631, 16.591943999999998, 13.11872, 8.600818,
        6.672481, 6.1424769999999995, 5.882499999999999, 4.522535, 3.6801959999999996,
        3.849032, 3.957668, 3.9024, 4.225826, 2.85881, 3.382236, 3.21678, 3.213253,
        2.5513790000000003, 2.412306, 2.747718, 2.2600000000000002, 1.897608,
        1.599936, 2.0679600000000002, 1.328598, 1.081404, 0.7143, 1.1132119999999999,
        0.653854, 1.03449, 0.8750070000000001, 0, NA
      ),
      rep(
        c(1L, 12L, 1L, 12L, 1L, 10L, 1L, 6L, 404L),
        c(89L, 1L, 89L, 1L, 91L, 1L, 95L, 1L, 1L)
      )
    ),
    EMI_NAT = rep(
      c(
        22.043125309720914, 48.738276000000006, 55.982466, 54.587862, 44.294724,
        38.861746, 33.459114, 28.722821999999997, 24.201428, 21.586733000000002,
        19.978886, 16.1736, 14.822994, 12.939777000000001, 11.898945, 10.36781,
        11.036016, 14.13258, 23.332232, 35.715255, 49.99969, 66.1752, 82.828182,
        101.31121, 130.693232, 145.565992, 161.55328799999998, 167.776726, 175.31352,
        154.977054, 145.718028, 144.288535, 135.395373, 120.59868, 108.32052,
        97.32264, 87.549845, 77.78694, 72.93832, 64.20569, 61.76896000000001,
        57.794256, 54.86579999999999, 50.83295, 48.659112, 43.289206,
        40.965022999999995, 39.525948, 35.708373, 34.549887999999996, 35.782382,
        35.259992000000004, 35.125820000000004, 35.63532, 35.312882,
        35.526568000000005, 36.219776, 35.66061, 35.262755999999996, 34.838054,
        33.51652, 31.47738, 29.911482, 28.20674, 33.443999999999996, 45.982269,
        22.231451, 21.992208, 20.3174, 18.847245, 17.276477999999997, 16.781349,
        15.608519999999999, 14.036915, 13.370688, 12.642608000000001, 12.3936,
        11.81866, 10.940082, 10.585398, 9.74554, 8.866431, 7.190994999999999,
        6.706359999999999, 4.944828, 3.9325, 4.205992, 3.792675, 2.7296139999999998,
        2.08808, 1.956471, 1.76616, 1.029294, 0.926234, 0.9474659999999999,
        0.8182440000000001, 0, 23.052371679967454, 63.633096, 56.074492,
        50.947874999999996, 39.925146000000005, 34.09371, 29.012079999999997,
        25.321080000000002, 21.697619999999997, 18.681582, 16.547833,
        14.708580000000001, 14.214774, 13.5304, 14.663241000000001,
        13.782540000000001, 17.356327, 21.482972, 31.616684, 47.588464,
        72.38736399999999, 100.38110599999999, 129.529008, 156.630656, 186.475762,
        207.39744600000003, 206.798235, 210.623885, 200.235956, 184.65973400000001,
        167.84834999999998, 146.750088, 137.447226, 118.09990400000001,
        104.47142400000001, 86.210173, 78.293655, 68.06599800000001, 60.85368,
        53.917856, 50.585879999999996, 46.910664000000004, 45.65025, 43.768944,
        39.82024, 37.940032, 34.457138, 34.776782000000004, 36.604158000000005,
        34.431776, 33.85228, 33.340728, 34.51943, 36.986748, 37.243077, 37.304465,
        38.762254999999996, 37.980796, 37.923135, 36.889635, 36.999989,
        35.235400000000006, 33.831738, 31.402284, 38.119697, 33.473924,
        27.015947999999998, 26.034296, 23.850431999999998, 22.505675, 20.214416,
        19.530720000000002, 18.136642000000002, 16.953801, 16.263907, 14.66608,
        13.795548, 12.89556, 12.050028, 10.740834, 9.85966, 9.91744,
        8.163621000000001, 6.46459, 5.475834, 4.9807559999999995, 4.867368, 3.805875,
        3.206673, 2.7703439999999997, 2.0567339999999996, 1.86992, 1.031765, 0.91952,
        1.02168, 0.9922500000000001, 0, 6.9819132433278055, 22.55715, 24.855359,
        22.585797, 19.518879000000002, 18.156893999999998, 16.259574999999998,
        14.29893, 13.762196, 10.865853, 10.238382, 8.546727, 8.249216,
        6.703466000000001, 5.46176, 4.989999999999999, 5.4072499999999994, 6.287814,
        11.302304, 17.83264, 24.889215999999998, 31.846107000000003, 42.38208,
        51.743308, 68.481308, 77.550538, 88.83690399999999, 98.266709,
        104.51083500000001, 102.492936, 105.897647, 107.96574600000001,
        105.30712799999999, 106.121622, 106.487388, 98.314301, 90.374046,
        91.59617800000001, 84.91296, 80.181664, 78.88382700000001, 72.516384,
        71.221836, 68.830788, 64.853504, 61.101026000000005, 57.788976, 53.476936,
        50.573285000000006, 46.448224, 43.51246, 42.0303, 40.166434, 35.79612,
        33.015762, 31.66533, 29.460772000000002, 28.371108, 25.999584000000002,
        23.436614, 21.205189999999998, 17.538336, 14.524692, 12.022275,
        11.234091999999999, 8.501702, 7.968246, 5.314764, 4.852624, 3.92364, 3.5739,
        2.6707300000000003, 1.9235190000000002, 2.030596, 2.27964, 1.672188, 1.06641,
        0.8767130000000001, 1.023, 0.8092480000000001, 1.206052, 0.977571, 1.087075,
        0.793936, 0, 4.989570693826729, 22.232096, 20.723798000000002, 21.0265,
        19.546295, 17.048896, 14.579149999999998, 12.522962000000001, 12.745272,
        10.302712000000001, 10.167993, 8.438727, 8.117707000000001, 6.33507,
        6.628017000000001, 5.736504, 4.92476, 6.9066920000000005, 11.261096,
        21.010496, 30.915318, 38.72513, 47.596379999999996, 54.338922000000004,
        64.182444, 69.125804, 75.961102, 80.950722, 78.721484, 80.272275, 76.895737,
        74.22266400000001, 72.703232, 66.962896, 64.685652, 59.295348,
        56.057539999999996, 51.294906, 47.830824, 44.888844, 42.103820000000006,
        39.697472000000005, 38.270219999999995, 35.603352, 33.288829,
        30.214392000000004, 31.049808, 27.632573999999998, 26.406750000000002,
        26.370624, 24.655455, 23.419007999999998, 24.400956, 22.555529999999997,
        20.260296, 20.328103, 18.79776, 18.148097, 16.620213, 13.940679999999999,
        13.529556, 11.01128, 8.255424, 6.761744, 6.195057, 4.366704, 2.81088,
        2.5800289999999997, 1.906205, 2.04732, 1.961, 1.8089250000000001,
        1.8400979999999998, 1.924516, 0.9896039999999999, 0.9756, 1.0565499999999999,
        0.714571, 1.1274119999999999, 0.8043100000000001, 1.071004, 0.850526, 0,
        0.915975, 0, NA
      ),
      rep(
        c(1L, 5L, 1L, 5L, 1L, 17L, 1L, 17L, 404L),
        c(96L, 1L, 96L, 1L, 84L, 1L, 84L, 1L, 1L)
      )
    ),
    IMM_INT = rep(
      c(
        5, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 6, 8, 9, 11, 12, 13, 14, 13,
        12, 11, 10, 9, 8, 9, 10, 11, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0, 4, 15,
        14, 13, 12, 11, 10, 9, 8, 7, 6, 7, 6, 7, 8, 9, 10, 11, 12, 13, 14, 13, 12, 11,
        10, 9, 8, 7, 6, 7, 6, 5, 4, 3, 2, 1, 0, 14, 55, 53, 51, 49, 47, 46, 45, 44,
        43, 42, 40, 38, 40, 47, 58, 72, 89, 107, 124, 138, 149, 158, 163, 165, 163,
        159, 154, 147, 140, 134, 127, 120, 114, 107, 101, 95, 90, 85, 80, 75, 71, 67,
        64, 60, 57, 53, 50, 46, 43, 38, 34, 29, 25, 22, 19, 16, 13, 11, 9, 8, 7, 6, 5,
        4, 3, 2, 1, 0, 18, 57, 53, 50, 48, 46, 45, 44, 42, 41, 40, 38, 37, 35, 33, 31,
        30, 37, 51, 72, 93, 113, 127, 136, 140, 137, 132, 126, 119, 112, 105, 98, 92,
        86, 81, 76, 71, 67, 63, 59, 55, 52, 49, 47, 44, 42, 40, 38, 36, 34, 32, 29,
        27, 23, 21, 18, 15, 13, 12, 10, 8, 7, 6, 5, 4, 3, 2, 1, 0, NA
      ),
      rep(
        c(
          1L, 2L, 1L, 2L, 1L, 2L, 3L, 1L, 9L, 2L, 3L, 2L, 4L, 2L, 1L, 2L, 3L, 1L, 3L,
          1L, 3L, 4L, 6L, 10L, 1L, 2L, 1L, 2L, 1L, 5L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 7L,
          2L, 1L, 2L, 1L, 3L, 4L, 5L, 8L, 6L, 4L, 5L, 7L, 9L, 6L, 1L, 2L, 1L, 2L, 1L,
          2L, 1L, 2L, 1L, 2L, 6L, 21L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 4L, 12L, 7L, 8L,
          404L
        ),
        c(
          2L, 1L, 1L, 1L, 7L, 1L, 1L, 6L, 1L, 1L, 2L, 2L, 1L, 1L, 1L, 2L, 1L, 1L, 1L,
          1L, 4L, 2L, 1L, 1L, 1L, 1L, 6L, 1L, 1L, 1L, 1L, 1L, 2L, 1L, 2L, 1L, 1L, 1L,
          1L, 2L, 1L, 2L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 5L, 1L, 1L, 2L, 3L,
          1L, 11L, 1L, 40L, 2L, 1L, 1L, 10L, 1L, 5L, 1L, 7L, 1L, 38L, 2L, 1L, 1L, 1L,
          1L, 1L
        )
      )
    ),
    IMM_NAT = rep(
      c(
        51, 94, 84, 73, 64, 50, 41, 34, 30, 26, 23, 21, 19, 18, 17, 16, 18, 20, 25,
        35, 50, 68, 88, 103, 121, 128, 138, 147, 155, 156, 155, 154, 148, 137, 124,
        114, 101, 93, 83, 78, 69, 65, 59, 56, 52, 47, 46, 43, 42, 41, 40, 39, 38, 39,
        37, 38, 35, 34, 35, 36, 29, 25, 22, 18, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5,
        4, 3, 2, 1, 0, 57, 85, 76, 67, 62, 46, 39, 33, 27, 23, 20, 18, 15, 14, 13, 15,
        20, 33, 51, 72, 96, 115, 138, 157, 182, 186, 184, 181, 169, 160, 152, 146,
        135, 125, 113, 103, 91, 84, 76, 68, 61, 56, 49, 46, 42, 39, 38, 37, 39, 40,
        41, 43, 42, 43, 42, 41, 42, 40, 38, 37, 33, 29, 25, 21, 19, 17, 16, 15, 14,
        12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0, 1, 19, 35, 28, 26, 22, 21, 20, 19,
        18, 16, 15, 13, 12, 14, 17, 23, 31, 40, 49, 61, 74, 92, 104, 114, 124, 130,
        133, 135, 138, 139, 137, 135, 128, 127, 117, 112, 106, 98, 91, 86, 80, 77, 69,
        65, 59, 55, 49, 47, 41, 39, 36, 34, 32, 30, 26, 25, 22, 20, 17, 14, 12, 9, 7,
        5, 3, 2, 1, 0, 20, 42, 33, 29, 27, 23, 20, 18, 16, 14, 12, 11, 9, 8, 7, 6, 7,
        9, 13, 21, 33, 42, 52, 61, 70, 81, 88, 95, 102, 104, 103, 97, 96, 90, 84, 80,
        74, 69, 63, 58, 54, 50, 44, 41, 39, 36, 33, 32, 31, 30, 28, 27, 26, 25, 24,
        23, 21, 19, 17, 15, 14, 13, 11, 9, 8, 7, 5, 4, 3, 2, 1, 0, NA
      ),
      rep(
        c(
          1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 3L, 4L, 3L, 5L,
          1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 5L, 2L, 1L, 2L,
          1L, 2L, 3L, 1L, 2L, 1L, 2L, 8L, 6L, 15L, 1L, 2L, 1L, 2L, 1L, 9L, 8L, 13L,
          404L
        ),
        c(
          15L, 1L, 12L, 1L, 19L, 1L, 1L, 1L, 1L, 2L, 16L, 3L, 1L, 1L, 1L, 1L, 1L, 1L,
          1L, 14L, 1L, 10L, 1L, 20L, 1L, 8L, 2L, 12L, 3L, 1L, 1L, 1L, 4L, 1L, 1L, 1L,
          4L, 1L, 7L, 1L, 1L, 47L, 1L, 2L, 2L, 1L, 1L, 1L, 64L, 1L, 2L, 1L, 1L, 1L, 1L,
          1L, 1L
        )
      )
    ),
    ACQ = rep(
      c(
        0, 0.9969182164711695, 12.8898, 15.817455, 16.425929, 16.591104,
        18.156893999999998, 19.308171, 19.066383000000002, 23.290248000000002,
        23.543242, 28.66654, 31.338741000000002, 37.12378399999999, 42.13307,
        42.781444, 43.912, 48.6674, 43.118892, 41.819815999999996, 22.78556,
        16.000072, 14.558797999999998, 13.79904, 11.498732, 13.04345, 11.779439,
        11.362988, 12.283149, 12.059759999999999, 11.284182, 12.103498, 14.126661,
        14.626968, 17.180664, 19.45524, 21.742062, 22.830976, 25.729753, 27.66852,
        28.356272, 30.340112, 30.1376, 32.100744, 31.464992, 30.97536, 29.596168,
        28.404299, 27.207936, 26.259024999999998, 23.698656, 21.272949999999998,
        20.52674, 20.082369999999997, 17.898856, 16.507109999999997,
        16.343700000000002, 14.730386000000001, 14.184788, 12.999792000000001,
        12.228646999999999, 11.566210000000002, 9.230904, 8.169644,
        6.4741610000000005, 6.127595, 4.250851, 3.984123, 2.657068, 2.911456, 1.96182,
        1.78695, 1.78063, 0.961961, 1.015298, 1.14004, 0.836094, 1.06641,
        0.8767130000000001, 1.023, 0.8092480000000001, 1.206052, 0.977571, 1.087075,
        0, 0.9981354548307184, 18.938624, 18.7495, 18.8133, 18.518085, 17.048896,
        16.523825, 17.338921, 20.181048, 23.415447999999998, 26.436564, 30.005613,
        33.483852999999996, 35.292591, 44.190531, 45.892032, 46.29532, 43.410588,
        36.599168000000006, 31.515328000000004, 27.050603999999996, 21.72376,
        18.45558, 17.465936, 16.834584, 15.80036, 13.344408, 12.453552000000002,
        10.691151999999999, 12.19272, 12.654404999999999, 16.047828, 20.480768,
        21.350672, 25.668544, 28.189968, 30.029846, 30.579164, 31.887216000000002,
        34.912878, 34.27101, 34.735288, 35.247528, 32.716232000000005,
        32.309250000000006, 29.299116, 30.0144, 26.710998, 22.635018, 23.327136,
        20.862765, 18.734928, 19.096014, 16.9163, 13.814304, 12.19608, 11.2789,
        10.082412, 8.79845, 7.435389000000001, 7.28523, 5.50564, 4.586736, 3.863736,
        3.097115, 2.619744, 1.87392, 1.72038, 0.953357, 1.02366, 0.9805,
        0.9046850000000001, 0.9200489999999999, 0, NA
      ),
      rep(c(202L, 1L, 18L, 1L, 28L, 404L), c(1L, 83L, 1L, 73L, 1L, 1L))
    ),
    MIG_SUB = numeric(808)
  )

  # run complement_projection
  output_table <- complement_projection(empty_df, raw_df, subregional = TRUE)

  # run tests
  expect_snapshot(constructive::construct(output_table))

  # Check if components add up
  balance_check <- check_balance(output_table)

  expect_equal(balance_check$nonzeros, 0,
    info =
      "The components don't add up in at least one row"
  )
  expect_equal(balance_check$missings, 0,
    info =
      "There are missings in at least one row"
  )
})
